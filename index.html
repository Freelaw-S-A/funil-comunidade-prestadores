<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funil Comunidade Prestadores - Freelaw</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: #FFFFFF;
            min-height: 100vh;
        }

        /* App Layout */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2D2460 0%, #1E1845 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }


        .nav-section {
            padding: 20px 12px;
        }

        .nav-section-title {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
            padding: 0 12px;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255,255,255,0.7);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            font-family: inherit;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: linear-gradient(90deg, #7C3AED 0%, #5B21B6 100%);
            color: white;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 16px 12px;
        }

        .nav-item.danger {
            color: #EF4444;
        }

        .nav-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 32px;
            background: #FFFFFF;
            min-height: 100vh;
        }

        /* Header */
        .header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-subtitle {
            font-size: 0.75rem;
            font-weight: 600;
            color: #7C3AED;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1F1F3D;
        }

        .header-meta {
            font-size: 0.85rem;
            color: #6B7280;
            margin-top: 4px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 10px 16px;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1F1F3D;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #22C55E;
            border-radius: 50%;
        }

        /* ==================== DASHBOARD CARDS STYLE ==================== */

        /* Grid de Cards Principais */
        .dashboard-cards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .dashboard-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .dashboard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .dashboard-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dashboard-card-icon.purple { background: #F3E8FF; }
        .dashboard-card-icon.yellow { background: #FEF3C7; }
        .dashboard-card-icon.pink { background: #FCE7F3; }
        .dashboard-card-icon.green { background: #DCFCE7; }

        .dashboard-card-icon svg {
            width: 20px;
            height: 20px;
        }

        .dashboard-card-icon.purple svg { color: #7C3AED; }
        .dashboard-card-icon.yellow svg { color: #D97706; }
        .dashboard-card-icon.pink svg { color: #DB2777; }
        .dashboard-card-icon.green svg { color: #16A34A; }

        .dashboard-card-badge {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6B7280;
            background: #F3F4F6;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .dashboard-card-badge.success {
            color: #16A34A;
            background: #DCFCE7;
        }

        .dashboard-card-label {
            font-size: 0.8rem;
            color: #6B7280;
            font-weight: 500;
        }

        .dashboard-card-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1F1F3D;
            line-height: 1;
        }

        /* Mini Cards Row */
        .mini-cards-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .mini-card {
            background: white;
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mini-card-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .mini-card-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mini-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F1F3D;
        }

        .mini-card-value.warning { color: #DC2626; }
        .mini-card-value.success { color: #16A34A; }

        .mini-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F9FAFB;
        }

        .mini-card-icon svg {
            width: 20px;
            height: 20px;
            color: #9CA3AF;
        }

        .mini-card-icon.warning { background: #FEF2F2; }
        .mini-card-icon.warning svg { color: #DC2626; }
        .mini-card-icon.success { background: #DCFCE7; }
        .mini-card-icon.success svg { color: #16A34A; }

        @media (max-width: 1024px) {
            .dashboard-cards-grid {
                grid-template-columns: 1fr;
            }
            .mini-cards-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .mini-cards-row {
                grid-template-columns: 1fr;
            }
        }

        /* ==================== APPLE-STYLE METRICS ==================== */

        /* Hero Metric - The One Number That Matters */
        .hero-metric {
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: relative;
            display: none;
            overflow: hidden;
        }

        .hero-metric::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

        .hero-content {
            z-index: 1;
        }

        .hero-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .hero-value {
            font-size: 4.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .hero-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .hero-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .hero-side {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
            z-index: 1;
        }

        .hero-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .hero-trend.up { color: #4ADE80; }
        .hero-trend.down { color: #F87171; }

        /* Conversion Funnel - Visual Storytelling */
        .funnel-metrics {
            display: none;
            grid-template-columns: 1fr auto 1fr auto 1fr auto 1fr;
            gap: 0;
            align-items: center;
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .funnel-step {
            text-align: center;
            padding: 0 20px;
        }

        .funnel-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1F1F3D;
            line-height: 1;
            margin-bottom: 6px;
        }

        .funnel-label {
            font-size: 0.85rem;
            color: #6B7280;
            margin-bottom: 4px;
        }

        .funnel-rate {
            font-size: 0.8rem;
            font-weight: 600;
            color: #22C55E;
            background: #DCFCE7;
            padding: 4px 10px;
            border-radius: 12px;
            display: inline-block;
        }

        .funnel-value.inactive {
            color: #9CA3AF;
        }

        .funnel-rate.inactive {
            color: #6B7280;
            background: #F3F4F6;
        }

        .funnel-arrow {
            color: #D1D5DB;
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .funnel-arrow-rate {
            font-size: 0.7rem;
            color: #9CA3AF;
            font-weight: 500;
        }

        /* Action Cards - Things That Need Attention */
        .action-cards {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .action-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .action-card.warning {
            border-left: 4px solid #F59E0B;
        }

        .action-card.success {
            border-left: 4px solid #22C55E;
        }

        .action-card.info {
            border-left: 4px solid #7C3AED;
        }

        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .action-icon.warning { background: #FEF3C7; color: #D97706; }
        .action-icon.success { background: #DCFCE7; color: #16A34A; }
        .action-icon.info { background: #F3E8FF; color: #7C3AED; }

        .action-icon svg {
            width: 24px;
            height: 24px;
        }

        .action-content {
            flex: 1;
        }

        .action-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1F1F3D;
            line-height: 1;
        }

        .action-label {
            font-size: 0.8rem;
            color: #6B7280;
            margin-top: 4px;
        }

        .action-arrow {
            color: #D1D5DB;
            font-size: 1.2rem;
        }

        /* Legacy support */
        .cards-grid { display: none; }
        .mini-cards-grid { display: none; }

        .mini-card-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .mini-card-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mini-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1F1F3D;
        }

        .mini-card-value.warning {
            color: #DC2626;
        }

        .mini-card-value.success {
            color: #16A34A;
        }

        .mini-card-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-card-icon svg {
            width: 24px;
            height: 24px;
            color: #9CA3AF;
        }

        .mini-card-icon.warning svg {
            color: #DC2626;
        }

        .mini-card-icon.success svg {
            color: #16A34A;
        }

        /* ==================== CANAIS DE ENTRADA ==================== */
        /* Sections Navigation */
        .page-section {
            display: none !important;
        }

        .page-section.active {
            display: block !important;
        }

        .section-canais {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F1F3D;
            margin-bottom: 4px;
        }

        .section-subtitle {
            font-size: 0.9rem;
            color: #6B7280;
        }

        .channel-cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .channel-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid #E5E7EB;
            transition: all 0.2s;
        }

        .channel-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Cores Freelaw para Canais */
        .channel-card.instagram { border-left-color: #DD2869; }
        .channel-card.linkedin { border-left-color: #241054; }
        .channel-card.google { border-left-color: #ECB43D; }
        .channel-card.indicacao { border-left-color: #5527AD; }
        .channel-card.outros { border-left-color: #A994E6; }

        .channel-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .channel-card.instagram .channel-icon { background: #FDF2F8; color: #DD2869; }
        .channel-card.linkedin .channel-icon { background: #EDF0F7; color: #241054; }
        .channel-card.google .channel-icon { background: #FEF9E7; color: #BC801F; }
        .channel-card.indicacao .channel-icon { background: #F3E8FF; color: #5527AD; }
        .channel-card.outros .channel-icon { background: #F5F3FF; color: #A994E6; }

        .channel-icon svg {
            width: 22px;
            height: 22px;
        }

        .channel-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .channel-name {
            font-size: 0.8rem;
            color: #6B7280;
            font-weight: 500;
        }

        .channel-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F1F3D;
        }

        .channel-percent {
            font-size: 0.85rem;
            font-weight: 600;
            color: #16A34A;
            background: #DCFCE7;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1F1F3D;
            margin-bottom: 20px;
        }

        .chart-container canvas {
            max-height: 280px;
        }

        .chart-full-width {
            margin-bottom: 32px;
        }

        .chart-full-width canvas {
            max-height: 320px;
        }

        /* Performance KPIs */
        .perf-kpis-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .perf-kpi-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .perf-kpi-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .perf-kpi-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .perf-kpi-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1F1F3D;
        }

        .perf-kpi-label {
            font-size: 0.85rem;
            color: #6B7280;
        }

        @media (max-width: 1200px) {
            .perf-kpis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .perf-kpis-grid {
                grid-template-columns: 1fr;
            }
        }

        .table-container {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .table-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1F1F3D;
            margin-bottom: 16px;
        }

        .areas-table {
            width: 100%;
            border-collapse: collapse;
        }

        .areas-table th,
        .areas-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        .areas-table th {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: #F9FAFB;
        }

        .areas-table td {
            font-size: 0.9rem;
            color: #1F1F3D;
        }

        .areas-table tr:hover {
            background: #F9FAFB;
        }

        .areas-table td:first-child {
            font-weight: 600;
        }

        .areas-table td:last-child {
            font-weight: 700;
            color: #7C3AED;
        }

        /* Filtros da Tabela */
        .table-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .table-search {
            flex: 1;
            min-width: 200px;
            padding: 10px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .table-search:focus {
            border-color: #7C3AED;
        }

        .table-filter-select {
            padding: 10px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            outline: none;
            min-width: 140px;
        }

        .table-filter-select:focus {
            border-color: #7C3AED;
        }

        /* Headers ordenáveis */
        .areas-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px;
        }

        .areas-table th.sortable:hover {
            background: #EDE9FE;
            color: #7C3AED;
        }

        .areas-table th.sortable::after {
            content: '↕';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 0.7rem;
        }

        .areas-table th.sortable.asc::after {
            content: '↑';
            opacity: 1;
            color: #7C3AED;
        }

        .areas-table th.sortable.desc::after {
            content: '↓';
            opacity: 1;
            color: #7C3AED;
        }

        /* Badge Tier */
        .tier-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .tier-badge.tier-s { background: #4C1D95; color: white; }
        .tier-badge.tier-a { background: #6D28D9; color: white; }
        .tier-badge.tier-b { background: #7C3AED; color: white; }
        .tier-badge.tier-c { background: #8B5CF6; color: white; }
        .tier-badge.tier-d { background: #A78BFA; color: white; }
        .tier-badge.onboarding { background: #DDD6FE; color: #4C1D95; }

        .table-results-info {
            font-size: 0.8rem;
            color: #6B7280;
            margin-top: 12px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .mini-cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .channel-cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 0;
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .mini-cards-grid {
                grid-template-columns: 1fr;
            }

            .channel-cards-grid {
                grid-template-columns: 1fr;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 16px;
            }

            .card-value {
                font-size: 2.5rem;
            }

            .areas-table {
                font-size: 0.8rem;
            }

            .areas-table th,
            .areas-table td {
                padding: 8px 10px;
            }
        }

        /* ==================== MarIA - Assistente Virtual ==================== */
        .maria-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .maria-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(124, 58, 237, 0.5);
        }

        .maria-fab svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        .maria-fab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ECB43D;
            color: #241054;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .maria-modal {
            display: none;
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 400px;
            max-height: 550px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.2);
            z-index: 1001;
            overflow: hidden;
            flex-direction: column;
        }

        .maria-modal.active {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .maria-header {
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .maria-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .maria-info { flex: 1; }

        .maria-name {
            color: white;
            font-size: 1rem;
            font-weight: 700;
        }

        .maria-status {
            color: rgba(255,255,255,0.8);
            font-size: 0.75rem;
        }

        .maria-close {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .maria-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .maria-prestador-info {
            display: none;
            padding: 12px 20px;
            background: linear-gradient(90deg, #F3E8FF 0%, #EDE9FE 100%);
            border-bottom: 1px solid #E5E7EB;
            align-items: center;
            gap: 10px;
        }

        .maria-prestador-info.active {
            display: flex;
        }

        .maria-prestador-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #7C3AED;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
        }

        .maria-prestador-details { flex: 1; }

        .maria-prestador-name {
            font-weight: 600;
            color: #1F1F3D;
            font-size: 0.85rem;
        }

        .maria-prestador-tier {
            font-size: 0.7rem;
            color: #6B7280;
        }

        .maria-prestador-clear {
            background: none;
            border: none;
            color: #6B7280;
            cursor: pointer;
            font-size: 1rem;
        }

        .maria-prestador-clear:hover {
            color: #EF4444;
        }

        .maria-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 250px;
            background: #FAFAFA;
        }

        .maria-message {
            display: flex;
            gap: 8px;
            max-width: 85%;
        }

        .maria-message.bot { align-self: flex-start; }
        .maria-message.user { align-self: flex-end; flex-direction: row-reverse; }

        .maria-message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.8rem;
        }

        .maria-message.bot .maria-message-avatar {
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
        }

        .maria-message.user .maria-message-avatar {
            background: #E5E7EB;
        }

        .maria-message-content {
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .maria-message.bot .maria-message-content {
            background: white;
            color: #1F1F3D;
            border: 1px solid #E5E7EB;
            border-bottom-left-radius: 4px;
        }

        .maria-message.user .maria-message-content {
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .maria-message-content strong {
            color: #7C3AED;
        }

        .maria-message.user .maria-message-content strong {
            color: #ECB43D;
        }

        .maria-suggestions {
            padding: 10px 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            background: white;
            border-top: 1px solid #E5E7EB;
        }

        .maria-suggestion {
            background: #F3E8FF;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            color: #7C3AED;
            cursor: pointer;
            transition: all 0.2s;
        }

        .maria-suggestion:hover {
            background: #7C3AED;
            color: white;
        }

        .maria-input-area {
            padding: 12px 16px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 10px;
            background: white;
        }

        .maria-input-area input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #E5E7EB;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .maria-input-area input:focus {
            outline: none;
            border-color: #7C3AED;
        }

        .maria-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .maria-send-btn:hover {
            transform: scale(1.05);
        }

        .maria-prestador-info.has-prestador {
            display: none;
            padding: 12px 20px;
            background: linear-gradient(90deg, #F3E8FF 0%, #EDE9FE 100%);
            border-bottom: 1px solid #E5E7EB;
        }

        .maria-prestador-info.active {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .maria-prestador-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #7C3AED;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .maria-prestador-details {
            flex: 1;
        }

        .maria-prestador-name {
            font-weight: 600;
            color: #1F1F3D;
            font-size: 0.9rem;
        }

        .maria-prestador-tier {
            font-size: 0.75rem;
            color: #6B7280;
        }

        .maria-prestador-clear {
            background: none;
            border: none;
            color: #6B7280;
            cursor: pointer;
            padding: 4px;
        }

        .maria-prestador-clear:hover {
            color: #EF4444;
        }

        .maria-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 300px;
        }

        .maria-message {
            display: flex;
            gap: 10px;
            max-width: 90%;
        }

        .maria-message.bot {
            align-self: flex-start;
        }

        .maria-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .maria-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .maria-message.bot .maria-message-avatar {
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
            color: white;
        }

        .maria-message.user .maria-message-avatar {
            background: #E5E7EB;
        }

        .maria-message-content {
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .maria-message.bot .maria-message-content {
            background: #F3F4F6;
            color: #1F1F3D;
            border-bottom-left-radius: 4px;
        }

        .maria-message.user .maria-message-content {
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .maria-message-content strong {
            color: #7C3AED;
        }

        .maria-message.user .maria-message-content strong {
            color: #ECB43D;
        }

        .maria-suggestions {
            padding: 12px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border-top: 1px solid #E5E7EB;
        }

        .maria-suggestion {
            background: #F3E8FF;
            border: none;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #7C3AED;
            cursor: pointer;
            transition: all 0.2s;
        }

        .maria-suggestion:hover {
            background: #7C3AED;
            color: white;
        }

        .maria-input-area {
            padding: 16px 20px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            gap: 12px;
        }

        .maria-input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 24px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .maria-input-area input:focus {
            outline: none;
            border-color: #7C3AED;
        }

        .maria-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7C3AED 0%, #5527AD 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .maria-send-btn:hover {
            transform: scale(1.1);
        }

        .maria-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .maria-typing {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
        }

        .maria-typing span {
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .maria-typing span:nth-child(2) { animation-delay: 0.2s; }
        .maria-typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Sidebar nav-item para MarIA */
        .nav-item.maria {
            background: linear-gradient(90deg, rgba(124, 58, 237, 0.2) 0%, rgba(124, 58, 237, 0.1) 100%);
            border: 1px solid rgba(124, 58, 237, 0.3);
            margin-top: 12px;
        }

        .nav-item.maria:hover {
            background: linear-gradient(90deg, rgba(124, 58, 237, 0.3) 0%, rgba(124, 58, 237, 0.2) 100%);
        }

        .nav-item.maria .maria-badge {
            background: #ECB43D;
            color: #241054;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: auto;
            font-weight: 700;
        }

        /* ==========================================
           SEÇÃO QUALIFICAÇÃO - LISTA DE PRESTADORES
           ========================================== */
        .dashboard-section.hidden {
            display: none;
        }

        .qualificacao-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .qualificacao-tab {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #E5E7EB;
            background: white;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6B7280;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .qualificacao-tab:hover {
            border-color: #7C3AED;
            color: #7C3AED;
        }
        .qualificacao-tab.active {
            background: #7C3AED;
            border-color: #7C3AED;
            color: white;
        }
        .qualificacao-tab .count {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        .qualificacao-tab.active .count {
            background: rgba(255,255,255,0.2);
        }

        .qualificacao-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }
        .qualificacao-search {
            flex: 1;
            min-width: 300px;
            padding: 12px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 0.875rem;
            outline: none;
        }
        .qualificacao-search:focus {
            border-color: #7C3AED;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        .qualificacao-select {
            padding: 12px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            min-width: 150px;
        }
        .qualificacao-btn-export {
            padding: 12px 20px;
            background: #7C3AED;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
        }
        .qualificacao-btn-export:hover {
            background: #6D28D9;
        }

        .qualificacao-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .qualificacao-table {
            width: 100%;
            border-collapse: collapse;
        }
        .qualificacao-table thead {
            background: linear-gradient(90deg, #7C3AED 0%, #5B21B6 100%);
        }
        .qualificacao-table th {
            padding: 16px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .qualificacao-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #F3F4F6;
            font-size: 0.875rem;
            color: #374151;
        }
        .qualificacao-table tbody tr:hover {
            background: #F9FAFB;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-badge.inscrito { background: #DBEAFE; color: #1E40AF; }
        .status-badge.aguardando-nota { background: #E0E7FF; color: #4338CA; }
        .status-badge.aprovado, .status-badge.aprovado-prova { background: #D1FAE5; color: #065F46; }
        .status-badge.ativo, .status-badge.ativo-confirmado { background: #10B981; color: white; }
        .status-badge.pendente { background: #FEF3C7; color: #92400E; }
        .status-badge.reprovado { background: #FEE2E2; color: #991B1B; }
        .status-badge.bloqueado { background: #FEE2E2; color: #991B1B; }
        .status-badge.desativado { background: #F3F4F6; color: #6B7280; }
        .status-badge.desistente { background: #FED7AA; color: #9A3412; }
        .status-badge.saida-voluntaria { background: #E5E7EB; color: #374151; }

        .qualificacao-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #F3F4F6;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            margin-bottom: 24px;
        }
        .qualificacao-back:hover { background: #E5E7EB; }
        .qualificacao-back svg { width: 16px; height: 16px; }

        .qualificacao-loading {
            text-align: center;
            padding: 48px;
            color: #6B7280;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODA0IiBoZWlnaHQ9IjEzNiIgdmlld0JveD0iMCAwIDgwNCAxMzYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xMTUuNDUyIDEwNy4wOTVMODYuNjA3NiAxMzMuNDA1QzgzLjIyNzMgMTM2LjQ5NSA3OC4wMDUgMTM2LjIwNyA3NC45Njg3IDEzMi43NDZMMi41NjQ5NSA1MC40MzY4Qy0wLjQ3MTI3IDQ2Ljk5NjEgLTAuMTg3ODg5IDQxLjY4MDUgMy4yMTI2OCAzOC41OTAxTDQzLjIwOTkgMi4xNDM1MUM0Ni41OTAyIC0wLjk0NjkyNyA1MS44MTI1IC0wLjY1ODQ4NSA1NC44NDg3IDIuODAyODFMNzcuNzAxMyAyOC42NTk1TDcyLjY4MTUgMzMuMjMzM0M2NS45MDA2IDM5LjQxNDIgNjUuMzMzOCA1MC4wMDQxIDcxLjQwNjIgNTYuOTA2MUwxMTUuNDcyIDEwNy4wOTVIMTE1LjQ1MloiIGZpbGw9IiNGRUZFRkUiLz4KPHBhdGggZD0iTTIxMS40OTcgOTEuODA2N0wyMDcuOTM0IDk1LjA2MkwyMDIuOTc1IDk5LjU3NDFMMTY1LjM0NiAxMzMuODU3QzE2MS45NjYgMTM2Ljk0OCAxNTYuNzQ0IDEzNi42NTkgMTUzLjcwOCAxMzMuMTk4TDgxLjMwMzcgNTAuOTA5OUM3OC4yNjc1IDQ3LjQ2OTIgNzguNTUwOSA0Mi4xNTM3IDgxLjk1MTUgMzkuMDYzMkwxMjEuOTQ5IDIuNTk2MDNDMTIwLjMyOSAtMC40OTQ0MTIgMTMwLjU1MSAtMC4yMDU5NzEgMTMzLjU4NyAzLjI1NTMyTDE2My40NDQgMzcuMTg4NEwyMDMuNzA0IDgyLjk0NzVMMjExLjQ5NyA5MS44MDY3WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTI0OS4xMjYgNTcuNTIzNUwyMjAuMjQxIDgzLjg1NDFMMjEyLjQ0OCA3NC45OTQ4TDE3Mi4xODggMjkuMjM1N0wyMDEuMDczIDIuOTA1MTFDMjA0LjQ1MyAtMC4xODUzMyAyMDkuNjc1IDAuMTAzMTExIDIxMi43MTEgMy41NjQ0TDI0OS43NzQgNDUuNjk3NEMyNTIuODEgNDkuMTM4MSAyNTIuNTI2IDU0LjQ1MzcgMjQ5LjEyNiA1Ny41NDQxVjU3LjUyMzVaIiBmaWxsPSIjRkVGRUZFIi8+CjxwYXRoIGQ9Ik0yOTEuNzU1IDU2LjMwNzlIMjc1LjM1OVY0NC4zNzg4SDI5MS44MzVWMzIuMDM3NkMyOTEuODM1IDE2LjYwNiAzMDIuMzIxIDguNDI2NjQgMzE2LjEwNSA4LjQyNjY0QzMyMC43IDguNDI2NjQgMzI1LjEzMyA5LjY4MzQxIDMyOS4xNDEgMTEuNjgxOUwzMjQuNTQ2IDIzLjI4MTRDMzIyLjE3NyAyMS45NDIyIDMxOS43MDggMjEuMDM1NiAzMTcuMzQgMjEuMDM1NkMzMTAuNDU4IDIxLjAzNTYgMzA2LjEwNiAyNC43ODU0IDMwNi4xMDYgMzMuNDU5MlY0NC4zNzg4SDMyOC40OTNWNTYuMzA3OUgzMDYuMTA2VjEyNy43MzhIMjkxLjc1NVY1Ni4zMDc5WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTM0My43OTUgNDQuMzc4OEgzNTcuMzE3VjYwLjczNzVDMzYxLjI0NCA0OC43MjYgMzcxLjkxMSA0Mi45NTcyIDM4MS41MDUgNDIuOTU3MkMzODYuMzQzIDQyLjk1NzIgMzkxLjM0MyA0NC4zNzg4IDM5NS4wMjcgNDcuNTUxNkwzODguNjMgNTkuMjMzNUMzODUuODM3IDU3LjY0NyAzODIuNzIgNTYuNzE5OSAzNzkuNDQxIDU2LjcxOTlDMzY5LjExOCA1Ni43MTk5IDM1Ny4yMzYgNjUuNDc2MiAzNTcuMjM2IDg3LjU4MzFWMTI3LjcxOEgzNDMuNzk1VjQ0LjM3ODhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMzk1LjQxMSA4Ni40Mjk0QzM5NS40MTEgNjMuNDc3NyA0MDguMjA0IDQyLjk1NzIgNDMzLjI4MyA0Mi45NTcyQzQ2MC43NTEgNDIuOTU3MiA0NjkuNjc3IDY1LjM5MzggNDY5LjY3NyA4Mi41OTcyQzQ2OS42NzcgODUuNjg3NiA0NjkuMzUzIDg5LjAyNTMgNDY5LjAyOSA5MC4yODIxSDQxMC4wODZDNDExLjE1OSAxMDYuMzExIDQxOS40MzggMTE2LjMyNCA0MzQuNzYxIDExNi4zMjRDNDQzLjc4OCAxMTYuMzI0IDQ1MC41MDggMTEzLjY0NiA0NTcuMzEgMTA2LjMxMUw0NjYuOTg1IDExNC45MDNDNDU3Ljg3NiAxMjQuODMzIDQ0OC4wNTkgMTI5LjE2IDQzNC42OCAxMjkuMTZDNDA4Ljc3MSAxMjkuMTYgMzk1LjQxMSAxMDkuODk2IDM5NS40MTEgODYuNDVWODYuNDI5NFpNNDU1LjkxMyA3OS45MTg4QzQ1NS45MTMgNzguMDg1MiA0NTUuOTEzIDc2LjMzMzkgNDU1LjU4OSA3NC42NjUxQzQ1NC4xOTIgNjQuMzIyNCA0NDYuOTg2IDU0Ljg4NjMgNDMzLjIwMiA1NC44ODYzQzQxOS40MTggNTQuODg2MyA0MTEuNjQ1IDY1LjMxMTMgNDEwLjA4NiA3OS45MTg4SDQ1NS45MTNaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNDgyLjIwNyA4Ni40Mjk0QzQ4Mi4yMDcgNjMuNDc3NyA0OTQuOTk5IDQyLjk1NzIgNTIwLjA3OCA0Mi45NTcyQzU0Ny41NDYgNDIuOTU3MiA1NTYuNDczIDY1LjM5MzggNTU2LjQ3MyA4Mi41OTcyQzU1Ni40NzMgODUuNjg3NiA1NTYuMTQ5IDg5LjAyNTMgNTU1LjgyNSA5MC4yODIxSDQ5Ni44ODJDNDk3Ljk1NCAxMDYuMzExIDUwNi4yMzMgMTE2LjMyNCA1MjEuNTU2IDExNi4zMjRDNTMwLjU2MyAxMTYuMzI0IDUzNy4yODQgMTEzLjY0NiA1NDQuMTA1IDEwNi4zMTFMNTUzLjc4IDExNC45MDNDNTQwLjY5MiAxMjQuODMzIDUzNC44NTUgMTI5LjE2IDUyMS40NzUgMTI5LjE2QzQ5NS41NjYgMTI5LjE2IDQ4Mi4yMDcgMTA5Ljg5NiA0ODIuMjA3IDg2LjQ1Vjg2LjQyOTRaTTU0Mi42ODggNzkuOTE4OEM1NDIuNjg4IDc4LjA4NTIgNTQyLjY4OCA3Ni4zMzM5IDU0Mi4zNjQgNzQuNjY1MUM1NDAuOTY4IDY0LjMyMjQgNTMzLjc2MiA1NC44ODYzIDUxOS45OTcgNTQuODg2M0M1MDYuMjMzIDU0Ljg4NjMgNDk4LjQ0IDY1LjMxMTMgNDk2Ljg4MiA3OS45MTg4SDU0Mi43MDhINTQyLjY4OFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik01NzIuMDU5IDExMC40NzNWOS44NDgyN0g1ODUuOTg1VjEwNi43MjNDNTg1Ljk4NSAxMTIuMzA3IDU4Ny4zODIgMTE2LjQwNyA1OTQuMTAyIDExNi40MDdDNTk1Ljc0MSAxMTYuNDA3IDU5OC4wMjkgMTE2LjE1OSA2MDAuNDE3IDExNS43NDdMNjAwLjQ5OCAxMjcuNjc2QzU5Ni43MzMgMTI4LjUwMSA1OTEuODE1IDEyOS4xOCA1ODcuODY3IDEyOS4xOEM1NzYuOTU3IDEyOS4xOCA1NzIuMDM5IDEyMy4yNDcgNTcyLjAzOSAxMTAuNDk0TDU3Mi4wNTkgMTEwLjQ3M1oiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik02ODAuMDA2IDc2LjkzMTRWMTI3LjczOEg2NjguNDQ4TDY2Ny41MzggMTEyLjg4NEM2NjEuNzA4IDEyMy43MjEgNjUwLjQxMyAxMjkuMTYgNjM5LjE3OSAxMjkuMTZDNjIyLjU0MSAxMjkuMTYgNjEwLjQxNiAxMTkuNTU5IDYxMC40MTYgMTAzLjAzNUM2MTAuNDE2IDg2LjUxMTggNjI0LjAxOCA3OS4xNzcxIDY0NC4xOTkgNzkuMTc3MUg2NjcuMzk2QzY2Ny4zMTUgNjIuOTAwOCA2NjIuMDcyIDU1LjMxODkgNjQ2LjU2NyA1NS4zMTg5QzYzNi4xNjMgNTUuMzE4OSA2MjkuMiA2MC41NzI3IDYyNC4yNjEgNjguMzRMNjEzLjYxNCA2MC40OTAzQzYyMS41NjkgNDkuMzg1MyA2MzEuNDA2IDQyLjk3NzggNjQ2LjQwNSA0Mi45Nzc4QzY2Ny44ODIgNDIuOTc3OCA2ODAuMDA2IDU2LjI0NjEgNjgwLjAwNiA3Ni45MzE0Wk02NjcuMzc2IDk0LjkzODRWODkuNTE5OEg2NDQuOTg5QzYzMS4yMjQgODkuNTE5OCA2MjQuNjY2IDk1LjEwMzIgNjI0LjY2NiAxMDMuNTNDNjI0LjY2NiAxMTEuOTU2IDYzMC43MzggMTE3LjA0NSA2NDEuODcxIDExNy4wNDVDNjU1LjcxNiAxMTcuMDQ1IDY2NC42NjMgMTA3LjQ0NCA2NjcuMzc2IDk0LjkzODRaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNjg4LjYwOSA0NC4zNzg4SDcwMy40NDZMNzIwLjAwNCAxMDYuMjkxTDczOS44NCA0NC4zNzg4SDc1Mi4xMjdMNzcxLjg4MyAxMDYuMjA4TDc4OC42MDIgNDQuMzc4OEg4MDMuNDM5TDc3OS4wMDggMTI3LjczOEg3NjYuMjE1TDc0NS45NzMgNjQuMDc1Mkw3MjUuNjUxIDEyNy43MzhINzEyLjg1OEw2ODguNTg5IDQ0LjM3ODhINjg4LjYwOVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==" alt="Freelaw" style="height: 32px;">
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">DASHBOARDS</div>
                <button class="nav-item active" data-section="funil" onclick="navigateTo('funil')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                    </svg>
                    <span>Funil Comunidade</span>
                </button>
                <button class="nav-item" data-section="canais" onclick="navigateTo('canais')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span>Canais de Entrada</span>
                </button>
                <button class="nav-item">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Capacity</span>
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">ANÁLISES</div>
                <button class="nav-item" data-section="carteirizacao" onclick="navigateTo('carteirizacao')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    <span>Carteirização</span>
                </button>
                <button class="nav-item" data-section="performance" onclick="navigateTo('performance')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    <span>Performance</span>
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">ASSISTENTE IA</div>
                <button class="nav-item maria" onclick="toggleMariaChat()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span>MarIA</span>
                    <span class="maria-badge">IA</span>
                </button>
            </div>

        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- ==================== SEÇÃO FUNIL ==================== -->
            <section class="page-section active" id="sectionFunil">
                <!-- Header Minimalista -->
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Principais Indicadores - Funil de Ativação Prestadores</h1>
                        <span class="header-meta" id="lastUpdate">Atualizado agora • Supabase</span>
                    </div>
                </header>

                <!-- DASHBOARD CARDS: Layout estilo Apple -->
                <div class="dashboard-cards-grid">
                    <!-- Card 1: Total Inscritos -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <div class="dashboard-card-icon purple">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                                </svg>
                            </div>
                            <span class="dashboard-card-badge" id="badgeAprovadosCard">56.7%</span>
                        </div>
                        <div class="dashboard-card-label">Total Inscritos</div>
                        <div class="dashboard-card-value" id="totalInscritosCard">...</div>
                    </div>

                    <!-- Card 2: Aprovados -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <div class="dashboard-card-icon pink">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-label">Aprovados</div>
                        <div class="dashboard-card-value" id="totalAprovadosCard">...</div>
                    </div>

                    <!-- Card 3: Taxa de Ativacao -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <div class="dashboard-card-icon yellow">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <span class="dashboard-card-badge success" id="badgeAtivadosCard">166 ativados</span>
                        </div>
                        <div class="dashboard-card-label">Taxa de Ativacao</div>
                        <div class="dashboard-card-value" id="taxaAtivacaoCard">48.3%</div>
                    </div>

                    <!-- Card 4: Ativos Agora -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <div class="dashboard-card-icon green">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                            <span class="dashboard-card-badge">Tier S-D</span>
                        </div>
                        <div class="dashboard-card-label">Ativos Agora</div>
                        <div class="dashboard-card-value" id="ativosAgoraCard">...</div>
                    </div>
                </div>

                <!-- MINI CARDS ROW -->
                <div class="mini-cards-row">
                    <!-- Pendentes Admin -->
                    <div class="mini-card">
                        <div class="mini-card-info">
                            <span class="mini-card-label">Pendentes Admin</span>
                            <span class="mini-card-value" id="pendentesAdminCard">...</span>
                        </div>
                        <div class="mini-card-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Bloqueados -->
                    <div class="mini-card">
                        <div class="mini-card-info">
                            <span class="mini-card-label">Bloqueados</span>
                            <span class="mini-card-value warning" id="bloqueadosCard">...</span>
                        </div>
                        <div class="mini-card-icon warning">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                    </div>

                    <!-- Churn Total -->
                    <div class="mini-card">
                        <div class="mini-card-info">
                            <span class="mini-card-label">Churn Total</span>
                            <span class="mini-card-value" id="churnTotalCard">...</span>
                        </div>
                        <div class="mini-card-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </div>
                    </div>

                </div>

                <!-- HERO: O número que importa -->
                <div class="hero-metric">
                    <div class="hero-content">
                        <div class="hero-label">Prestadores Ativos</div>
                        <div class="hero-value" id="ativosAgora">...</div>
                        <div class="hero-subtitle">Prontos para atender demandas</div>
                    </div>
                    <div class="hero-side">
                        <span class="hero-badge">Tier S → D</span>
                        <div class="hero-trend up">
                            <span>↑</span>
                            <span>+12 este mês</span>
                        </div>
                    </div>
                </div>

                <!-- FUNIL: A jornada visual -->
                <div class="funnel-metrics">
                    <div class="funnel-step">
                        <div class="funnel-value" id="totalInscritos">...</div>
                        <div class="funnel-label">Inscritos</div>
                        <span class="funnel-rate">100%</span>
                    </div>

                    <div class="funnel-arrow">
                        <span>→</span>
                        <span class="funnel-arrow-rate" id="badgeAprovados">56.5%</span>
                    </div>

                    <div class="funnel-step">
                        <div class="funnel-value" id="totalAprovados">...</div>
                        <div class="funnel-label">Aprovados</div>
                        <span class="funnel-rate">Prova ≥7</span>
                    </div>

                    <div class="funnel-arrow">
                        <span>→</span>
                        <span class="funnel-arrow-rate" id="taxaAtivacao">64.1%</span>
                    </div>

                    <div class="funnel-step">
                        <div class="funnel-value" id="badgeAtivados">...</div>
                        <div class="funnel-label">Ativos</div>
                        <span class="funnel-rate">1+ serviço</span>
                    </div>

                    <div class="funnel-arrow">
                        <span>→</span>
                        <span class="funnel-arrow-rate">5.6%</span>
                    </div>

                    <div class="funnel-step inactive">
                        <div class="funnel-value inactive">7</div>
                        <div class="funnel-label">Inativos</div>
                        <span class="funnel-rate inactive">Sem atividade</span>
                    </div>
                </div>

                <!-- ACTION CARDS: O que precisa de atenção -->
                <div class="action-cards">
                    <div class="action-card warning">
                        <div class="action-icon warning">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="action-content">
                            <div class="action-value" id="pendentesAdmin">...</div>
                            <div class="action-label">Aguardando aprovação</div>
                        </div>
                        <span class="action-arrow">›</span>
                    </div>

                    <div class="action-card info">
                        <div class="action-icon info">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                        </div>
                        <div class="action-content">
                            <div class="action-value">93</div>
                            <div class="action-label">Em onboarding</div>
                        </div>
                        <span class="action-arrow">›</span>
                    </div>

                    <div class="action-card success">
                        <div class="action-icon success">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="action-content">
                            <div class="action-value">25</div>
                            <div class="action-label">Tier S-D ativos</div>
                        </div>
                        <span class="action-arrow">›</span>
                    </div>
                </div>

                <!-- Legacy cards hidden -->
                <div class="cards-grid" style="display:none;"></div>
                <div class="mini-cards-grid" style="display:none;"></div>

            <!-- Funil Ampulheta -->
            <div class="funnel-section" style="margin-top: 32px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <h2 style="font-size: 1.1rem; font-weight: 700; color: #1F1F3D; margin-bottom: 16px; text-align: center;">Funil Ampulheta</h2>
                <div class="funnel-container" style="display: flex; flex-direction: column; align-items: center; gap: 4px; width: 100%; max-width: 450px;">

                    <!-- Inscritos -->
                    <div style="width: 100%; background: #4C1D95; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 28px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg fill="none" stroke="white" viewBox="0 0 24 24" width="14" height="14">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                                </svg>
                            </div>
                            <span style="font-size: 0.85rem; font-weight: 600; color: white;">Inscritos</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="funnelInscritos" style="font-size: 1.2rem; font-weight: 700; color: white;">...</span>
                            <span style="font-size: 0.7rem; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">100%</span>
                        </div>
                    </div>

                    <!-- Aprovados Prova -->
                    <div style="width: 92%; background: #6D28D9; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 26px; height: 26px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg fill="none" stroke="white" viewBox="0 0 24 24" width="13" height="13">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <span style="font-size: 0.8rem; font-weight: 600; color: white;">Aprovados Prova</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="funnelAprovados" style="font-size: 1.1rem; font-weight: 700; color: white;">...</span>
                            <span id="funnelAprovadosPerc" style="font-size: 0.7rem; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">56.5%</span>
                        </div>
                    </div>

                    <!-- Ativados -->
                    <div style="width: 84%; background: #7C3AED; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 24px; height: 24px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg fill="none" stroke="white" viewBox="0 0 24 24" width="12" height="12">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                            <span style="font-size: 0.8rem; font-weight: 600; color: white;">Ativados</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="funnelAtivados" style="font-size: 1.05rem; font-weight: 700; color: white;">...</span>
                            <span id="funnelAtivadosPerc" style="font-size: 0.7rem; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">36.2%</span>
                        </div>
                    </div>

                    <!-- Tier S -->
                    <div style="width: 76%; background: #8B5CF6; padding: 8px 14px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 22px; height: 22px; background: rgba(255,255,255,0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 0.6rem; font-weight: 800; color: white;">S</span>
                            </div>
                            <span style="font-size: 0.75rem; font-weight: 600; color: white;">Tier S</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="funnelTierS" style="font-size: 0.95rem; font-weight: 700; color: white;">6</span>
                            <span id="funnelTierSPerc" style="font-size: 0.65rem; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.15); padding: 2px 5px; border-radius: 3px;">4.8%</span>
                        </div>
                    </div>

                    <!-- Tier A -->
                    <div style="width: 80%; background: #A78BFA; padding: 8px 14px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 22px; height: 22px; background: rgba(255,255,255,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 0.6rem; font-weight: 800; color: #4C1D95;">A</span>
                            </div>
                            <span style="font-size: 0.75rem; font-weight: 600; color: white;">Tier A</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="funnelTierA" style="font-size: 0.95rem; font-weight: 700; color: white;">5</span>
                            <span id="funnelTierAPerc" style="font-size: 0.65rem; color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 3px;">4.0%</span>
                        </div>
                    </div>

                    <!-- Tier B -->
                    <div style="width: 84%; background: #C4B5FD; padding: 8px 14px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 22px; height: 22px; background: rgba(76,29,149,0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 0.6rem; font-weight: 800; color: #4C1D95;">B</span>
                            </div>
                            <span style="font-size: 0.75rem; font-weight: 600; color: #4C1D95;">Tier B</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="funnelTierB" style="font-size: 0.95rem; font-weight: 700; color: #4C1D95;">2</span>
                            <span id="funnelTierBPerc" style="font-size: 0.65rem; color: #4C1D95; background: rgba(76,29,149,0.12); padding: 2px 5px; border-radius: 3px;">1.6%</span>
                        </div>
                    </div>

                    <!-- Tier C -->
                    <div style="width: 88%; background: #DDD6FE; padding: 8px 14px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 22px; height: 22px; background: rgba(76,29,149,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 0.6rem; font-weight: 800; color: #4C1D95;">C</span>
                            </div>
                            <span style="font-size: 0.75rem; font-weight: 600; color: #4C1D95;">Tier C</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="funnelTierC" style="font-size: 0.95rem; font-weight: 700; color: #4C1D95;">4</span>
                            <span id="funnelTierCPerc" style="font-size: 0.65rem; color: #4C1D95; background: rgba(76,29,149,0.1); padding: 2px 5px; border-radius: 3px;">3.2%</span>
                        </div>
                    </div>

                    <!-- Tier D -->
                    <div style="width: 92%; background: #EDE9FE; padding: 8px 14px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 22px; height: 22px; background: rgba(76,29,149,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 0.6rem; font-weight: 800; color: #4C1D95;">D</span>
                            </div>
                            <span style="font-size: 0.75rem; font-weight: 600; color: #4C1D95;">Tier D</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="funnelTierD" style="font-size: 0.95rem; font-weight: 700; color: #4C1D95;">8</span>
                            <span id="funnelTierDPerc" style="font-size: 0.65rem; color: #4C1D95; background: rgba(76,29,149,0.08); padding: 2px 5px; border-radius: 3px;">6.4%</span>
                        </div>
                    </div>

                    <!-- Onboarding -->
                    <div style="width: 96%; background: #A855F7; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 24px; background: rgba(255,255,255,0.25); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg fill="none" stroke="white" viewBox="0 0 24 24" width="12" height="12">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <span style="font-size: 0.8rem; font-weight: 600; color: white;">Onboarding</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="tierOnboardingCount" style="font-size: 1rem; font-weight: 700; color: white;">93</span>
                            <span id="tierOnboardingPerc" style="font-size: 0.65rem; color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 3px;">74.4%</span>
                        </div>
                    </div>

                    <!-- Inativo -->
                    <div style="width: 100%; background: #F5F3FF; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 24px; background: rgba(76,29,149,0.12); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <svg fill="none" stroke="#6B7280" viewBox="0 0 24 24" width="12" height="12">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                </svg>
                            </div>
                            <span style="font-size: 0.8rem; font-weight: 600; color: #6B7280;">Inativo</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span id="tierInativoCount" style="font-size: 1rem; font-weight: 700; color: #6B7280;">7</span>
                            <span id="tierInativoPerc" style="font-size: 0.65rem; color: #9CA3AF; background: rgba(76,29,149,0.06); padding: 2px 5px; border-radius: 3px;">5.6%</span>
                        </div>
                    </div>

                </div>

                <!-- Detalhamento dos Tiers abaixo da ampulheta -->
                <div style="width: 100%; max-width: 450px; margin-top: 20px; background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%); border-radius: 10px; padding: 16px;">
                    <div style="text-align: center; margin-bottom: 12px;">
                        <span style="font-size: 0.8rem; font-weight: 600; color: #4C1D95;">Detalhamento por Tier</span>
                        <span style="font-size: 0.65rem; color: #7C3AED; margin-left: 6px;">(Query 3697)</span>
                    </div>

                    <!-- Grid de Tiers compacto -->
                    <div style="display: flex; justify-content: center; gap: 6px; flex-wrap: wrap;" id="tierGrid">
                        <div style="background: #4C1D95; border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 50px;">
                            <div style="font-size: 0.55rem; font-weight: 700; color: rgba(255,255,255,0.8); text-transform: uppercase;">Tier S</div>
                            <div id="tierSCount" style="font-size: 1rem; font-weight: 700; color: white;">6</div>
                        </div>
                        <div style="background: #6D28D9; border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 50px;">
                            <div style="font-size: 0.55rem; font-weight: 700; color: rgba(255,255,255,0.8); text-transform: uppercase;">Tier A</div>
                            <div id="tierACount" style="font-size: 1rem; font-weight: 700; color: white;">5</div>
                        </div>
                        <div style="background: #7C3AED; border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 50px;">
                            <div style="font-size: 0.55rem; font-weight: 700; color: rgba(255,255,255,0.8); text-transform: uppercase;">Tier B</div>
                            <div id="tierBCount" style="font-size: 1rem; font-weight: 700; color: white;">2</div>
                        </div>
                        <div style="background: #8B5CF6; border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 50px;">
                            <div style="font-size: 0.55rem; font-weight: 700; color: rgba(255,255,255,0.8); text-transform: uppercase;">Tier C</div>
                            <div id="tierCCount" style="font-size: 1rem; font-weight: 700; color: white;">4</div>
                        </div>
                        <div style="background: #A78BFA; border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 50px;">
                            <div style="font-size: 0.55rem; font-weight: 700; color: white; text-transform: uppercase;">Tier D</div>
                            <div id="tierDCount" style="font-size: 1rem; font-weight: 700; color: white;">8</div>
                        </div>
                        <div style="background: #DDD6FE; border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 50px;">
                            <div style="font-size: 0.55rem; font-weight: 700; color: #4C1D95; text-transform: uppercase;">Inativo</div>
                            <div id="tierInativoCount" style="font-size: 1rem; font-weight: 700; color: #4C1D95;">7</div>
                        </div>
                    </div>

                    <!-- Barra de progresso visual -->
                    <div style="margin-top: 12px; background: #EDE9FE; border-radius: 5px; height: 20px; overflow: hidden; display: flex;">
                        <div id="barTierS" style="background: #4C1D95; height: 100%; width: 4.8%; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700; color: white;" title="Tier S: 6">S</div>
                        <div id="barTierA" style="background: #6D28D9; height: 100%; width: 4.0%; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700; color: white;" title="Tier A: 5">A</div>
                        <div id="barTierB" style="background: #7C3AED; height: 100%; width: 1.6%; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700; color: white;" title="Tier B: 2"></div>
                        <div id="barTierC" style="background: #8B5CF6; height: 100%; width: 3.2%; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700; color: white;" title="Tier C: 4">C</div>
                        <div id="barTierD" style="background: #A78BFA; height: 100%; width: 6.4%; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700; color: white;" title="Tier D: 8">D</div>
                        <div id="barOnboarding" style="background: #A855F7; height: 100%; width: 74.4%; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: 700; color: white;" title="Onboarding: 93">Onboarding</div>
                        <div id="barInativo" style="background: #DDD6FE; height: 100%; width: 5.6%; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700; color: #4C1D95;" title="Inativo: 7"></div>
                    </div>
                </div>

                <!-- Legenda -->
                <div style="width: 100%; max-width: 450px; display: flex; justify-content: center; gap: 20px; margin-top: 16px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 10px; height: 10px; background: #4C1D95; border-radius: 2px;"></div>
                        <span style="font-size: 0.7rem; color: #6B7280;">Tier S = Elite (Top Performers)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 10px; height: 10px; background: #A855F7; border-radius: 2px;"></div>
                        <span style="font-size: 0.7rem; color: #6B7280;">Onboarding = Aguardando classificação</span>
                    </div>
                </div>
            </div>
            </section>

            <!-- ==================== SEÇÃO CARTEIRIZAÇÃO ==================== -->
            <section class="page-section" id="sectionCarteirizacao">
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Carteira de Qualidade</h1>
                        <span class="header-meta" id="lastUpdateCarteirizacao">Segmentação por Nota Média (30 dias) • <span id="totalPrestadoresCarteira">0</span> Prestadores totais</span>
                    </div>
                </header>

                <!-- Cards de Segmentos -->
                <div class="dashboard-cards-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;">
                    <!-- Alta Performance -->
                    <div class="dashboard-card" style="cursor: pointer; border-left: 4px solid #22C55E;" onclick="filtrarCarteirizacao('alta')">
                        <div class="dashboard-card-header">
                            <div class="dashboard-card-icon" style="background: #DCFCE7;">
                                <svg fill="none" stroke="#22C55E" viewBox="0 0 24 24" style="width: 22px; height: 22px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-label">Alta Performance</div>
                        <div class="dashboard-card-value" id="countAlta">0</div>
                        <div style="font-size: 0.7rem; color: #6B7280;">Nota média ≥ 4.5</div>
                    </div>

                    <!-- Bom Desempenho -->
                    <div class="dashboard-card" style="cursor: pointer; border-left: 4px solid #3B82F6;" onclick="filtrarCarteirizacao('bom')">
                        <div class="dashboard-card-header">
                            <div class="dashboard-card-icon" style="background: #DBEAFE;">
                                <svg fill="none" stroke="#3B82F6" viewBox="0 0 24 24" style="width: 22px; height: 22px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-label">Bom Desempenho</div>
                        <div class="dashboard-card-value" id="countBom">0</div>
                        <div style="font-size: 0.7rem; color: #6B7280;">Nota média entre 4.0 e 4.49</div>
                    </div>

                    <!-- Em Desenvolvimento -->
                    <div class="dashboard-card" style="cursor: pointer; border-left: 4px solid #ECB43D;" onclick="filtrarCarteirizacao('desenvolvimento')">
                        <div class="dashboard-card-header">
                            <div class="dashboard-card-icon" style="background: #FEF3C7;">
                                <svg fill="none" stroke="#ECB43D" viewBox="0 0 24 24" style="width: 22px; height: 22px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-label">Em Desenvolvimento</div>
                        <div class="dashboard-card-value" id="countDesenvolvimento">0</div>
                        <div style="font-size: 0.7rem; color: #6B7280;">Nota média < 4.0 (com avaliações)</div>
                    </div>

                    <!-- Sem Avaliação -->
                    <div class="dashboard-card" style="cursor: pointer; border-left: 4px solid #DD2869;" onclick="filtrarCarteirizacao('semavaliacao')">
                        <div class="dashboard-card-header">
                            <div class="dashboard-card-icon" style="background: #FCE7F3;">
                                <svg fill="none" stroke="#DD2869" viewBox="0 0 24 24" style="width: 22px; height: 22px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="dashboard-card-label">Sem Avaliação</div>
                        <div class="dashboard-card-value" id="countSemAvaliacao">0</div>
                        <div style="font-size: 0.7rem; color: #6B7280;">Novatos ou sem serviços recentes</div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="charts-row" style="margin-bottom: 24px;">
                    <div class="chart-container">
                        <h3 class="chart-title">Distribuição por Qualidade</h3>
                        <canvas id="chartCarteirizacao"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Ações de Qualidade</h3>
                        <div style="padding: 16px; display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: flex-start; gap: 14px; padding: 14px 16px; background: #F0FDF4; border-radius: 12px; border-left: 4px solid #22C55E;">
                                <div style="width: 32px; height: 32px; background: #DCFCE7; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg fill="none" stroke="#22C55E" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #166534; margin-bottom: 2px;">Alta Performance (<span id="countAltaAcao">0</span>)</div>
                                    <div style="font-size: 0.8rem; color: #6B7280; line-height: 1.4;">Fidelizar com demandas complexas e ticket mais alto. Verificar disponibilidade.</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 14px; padding: 14px 16px; background: #EFF6FF; border-radius: 12px; border-left: 4px solid #3B82F6;">
                                <div style="width: 32px; height: 32px; background: #DBEAFE; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg fill="none" stroke="#3B82F6" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/></svg>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #1E40AF; margin-bottom: 2px;">Bom Desempenho (<span id="countBomAcao">0</span>)</div>
                                    <div style="font-size: 0.8rem; color: #6B7280; line-height: 1.4;">Identificar gaps para subir nota (prazo vs qualidade). Aumentar volume gradual.</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 14px; padding: 14px 16px; background: #FFFBEB; border-radius: 12px; border-left: 4px solid #ECB43D;">
                                <div style="width: 32px; height: 32px; background: #FEF3C7; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg fill="none" stroke="#D97706" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #92400E; margin-bottom: 2px;">Em Desenvolvimento (<span id="countDesenvolvimentoAcao">0</span>)</div>
                                    <div style="font-size: 0.8rem; color: #6B7280; line-height: 1.4;">Suspender novas demandas até feedback. Realizar call de alinhamento.</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: flex-start; gap: 14px; padding: 14px 16px; background: #FDF2F8; border-radius: 12px; border-left: 4px solid #DD2869;">
                                <div style="width: 32px; height: 32px; background: #FCE7F3; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <svg fill="none" stroke="#DD2869" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #9D174D; margin-bottom: 2px;">Sem Avaliação (<span id="countSemAvaliacaoAcao">0</span>)</div>
                                    <div style="font-size: 0.8rem; color: #6B7280; line-height: 1.4;">Enviar primeiro serviço para avaliar qualidade. Acompanhar onboarding.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros e Tabela -->
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 class="table-title" style="margin: 0;">Prestadores por Segmento</h3>
                        <div class="qualificacao-tabs" id="carteirizacaoTabs" style="margin: 0;">
                            <button class="qualificacao-tab active" data-filter="todos" onclick="filtrarCarteirizacao('todos')">Todos</button>
                            <button class="qualificacao-tab" data-filter="alta" onclick="filtrarCarteirizacao('alta')">Alta Performance</button>
                            <button class="qualificacao-tab" data-filter="bom" onclick="filtrarCarteirizacao('bom')">Bom Desempenho</button>
                            <button class="qualificacao-tab" data-filter="desenvolvimento" onclick="filtrarCarteirizacao('desenvolvimento')">Em Desenvolvimento</button>
                            <button class="qualificacao-tab" data-filter="semavaliacao" onclick="filtrarCarteirizacao('semavaliacao')">Sem Avaliação</button>
                        </div>
                    </div>
                    <div class="qualificacao-filters" style="margin-bottom: 16px;">
                        <input type="text" class="qualificacao-search" id="carteirizacaoSearch" placeholder="Buscar por nome ou OAB...">
                        <select class="qualificacao-select" id="carteirizacaoArea">
                            <option value="">Todas as áreas</option>
                            <option value="Direito Civil">Direito Civil</option>
                            <option value="Direito Trabalhista">Direito Trabalhista</option>
                            <option value="Direito Previdenciário">Direito Previdenciário</option>
                            <option value="Direito Empresarial">Direito Empresarial</option>
                            <option value="Direito Tributário">Direito Tributário</option>
                            <option value="Direito Penal">Direito Penal</option>
                        </select>
                    </div>
                    <table class="areas-table" id="carteirizacaoTable">
                        <thead>
                            <tr>
                                <th>Segmento</th>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>OAB</th>
                                <th>Área</th>
                                <th>Tier</th>
                                <th>Média 30d</th>
                                <th>WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody id="carteirizacaoTableBody">
                            <tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                    <div class="table-results-info" id="carteirizacaoResultsInfo"></div>
                </div>
            </section>

            <!-- ==================== SEÇÃO CANAIS DE ENTRADA ==================== -->
            <section class="page-section section-canais" id="sectionCanais">
                <!-- Header Canais -->
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Canais de Entrada</h1>
                        <span class="header-meta">Origem dos prestadores inscritos na plataforma</span>
                    </div>
                </header>

                <!-- Channel Cards (renderizado dinamicamente, ordenado do maior para menor) -->
                <div class="channel-cards-grid" id="channelCardsContainer">
                    <div style="grid-column: span 5; text-align: center; color: #999; padding: 40px;">Carregando...</div>
                </div>

                <!-- Charts Row -->
                <div class="charts-row">
                    <div class="chart-container">
                        <h3 class="chart-title">Distribuição por Canal</h3>
                        <canvas id="chartDistribuicao"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Conversão por Canal</h3>
                        <canvas id="chartConversao"></canvas>
                    </div>
                </div>

                <!-- Evolution Chart -->
                <div class="chart-container chart-full-width">
                    <h3 class="chart-title">Evolução de Aquisição por Canal</h3>
                    <canvas id="chartEvolucao"></canvas>
                </div>

                <!-- Areas Table -->
                <div class="table-container">
                    <h3 class="table-title">Áreas de Atuação por Canal</h3>
                    <table class="areas-table">
                        <thead>
                            <tr>
                                <th>Área</th>
                                <th>Instagram</th>
                                <th>LinkedIn</th>
                                <th>Google</th>
                                <th>Indicação</th>
                                <th>Outros</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="areasTableBody">
                            <tr><td colspan="7" style="text-align:center;color:#999;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ==================== SEÇÃO PERFORMANCE ==================== -->
            <section class="page-section" id="sectionPerformance">
                <!-- Header Performance -->
                <header class="header">
                    <div class="header-left">
                        <h1 class="header-title">Performance dos Prestadores</h1>
                        <span class="header-meta" id="lastUpdatePerf">Prestadores ativos da comunidade • Query 3622</span>
                    </div>
                    <div class="status-badge">
                        <span class="status-dot"></span>
                        <span id="totalPrestadoresAtivos">-- prestadores</span>
                    </div>
                </header>

                <!-- KPIs Performance -->
                <div class="perf-kpis-grid">
                    <div class="perf-kpi-card">
                        <div class="perf-kpi-icon" style="background: #DCFCE7;">
                            <svg fill="none" stroke="#16A34A" viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="perf-kpi-content">
                            <span class="perf-kpi-value" id="perfTotalAtivos">--</span>
                            <span class="perf-kpi-label">Prestadores Ativos</span>
                        </div>
                    </div>
                    <div class="perf-kpi-card">
                        <div class="perf-kpi-icon" style="background: #FEF3C7;">
                            <svg fill="none" stroke="#D97706" viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                        </div>
                        <div class="perf-kpi-content">
                            <span class="perf-kpi-value" id="perfMedia30d">--</span>
                            <span class="perf-kpi-label">Média 30 dias</span>
                        </div>
                    </div>
                    <div class="perf-kpi-card">
                        <div class="perf-kpi-icon" style="background: #DBEAFE;">
                            <svg fill="none" stroke="#2563EB" viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div class="perf-kpi-content">
                            <span class="perf-kpi-value" id="perfTotalAreas">--</span>
                            <span class="perf-kpi-label">Áreas de Atuação</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-row" style="grid-template-columns: 1fr;">
                    <div class="chart-container">
                        <h3 class="chart-title">Distribuição por Tier</h3>
                        <canvas id="chartTiers"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="chart-title">Distribuição por Área</h3>
                        <canvas id="chartAreas"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Atividade 30 dias -->
                <div class="charts-row" style="margin-top: 24px;">
                    <div class="chart-container">
                        <h3 class="chart-title">Atividade nos Últimos 30 Dias</h3>
                        <canvas id="chartAtividade30d"></canvas>
                    </div>
                    <div class="chart-container" style="display: flex; flex-direction: column; justify-content: center;">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3rem; font-weight: 700; color: #ECB43D;" id="percAtivos30d">0%</div>
                            <div style="font-size: 0.9rem; color: #6B7280; margin-top: 8px;">dos prestadores ativos</div>
                            <div style="font-size: 0.85rem; color: #9CA3AF;">pegaram serviço nos últimos 30 dias</div>
                            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 24px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #ECB43D;" id="qtdAtivos30d">0</div>
                                    <div style="font-size: 0.75rem; color: #6B7280;">Pegaram</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #DD2869;" id="qtdInativos30d">0</div>
                                    <div style="font-size: 0.75rem; color: #6B7280;">Não Pegaram</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Prestadores -->
                <div class="table-container">
                    <h3 class="table-title">Prestadores Ativos da Comunidade</h3>

                    <!-- Filtros -->
                    <div class="table-filters">
                        <input type="text" class="table-search" id="perfSearch" placeholder="Buscar por nome ou OAB...">
                        <select class="table-filter-select" id="perfFilterArea">
                            <option value="">Todas as áreas</option>
                            <option value="Direito Civil">Direito Civil</option>
                            <option value="Trabalhista">Trabalhista</option>
                            <option value="Previdenciário">Previdenciário</option>
                            <option value="Penal">Penal</option>
                            <option value="Empresarial">Empresarial</option>
                            <option value="Tributário">Tributário</option>
                            <option value="Família">Família</option>
                            <option value="Consumidor">Consumidor</option>
                        </select>
                        <select class="table-filter-select" id="perfFilterTier">
                            <option value="">Todos os Tiers</option>
                            <option value="S">Tier S</option>
                            <option value="A">Tier A</option>
                            <option value="B">Tier B</option>
                            <option value="C">Tier C</option>
                            <option value="D">Tier D</option>
                            <option value="Onboarding">Onboarding</option>
                        </select>
                    </div>

                    <table class="areas-table" id="perfTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="nome">Nome</th>
                                <th class="sortable" data-sort="email">Email</th>
                                <th class="sortable" data-sort="oab">OAB</th>
                                <th class="sortable" data-sort="area">Área</th>
                                <th class="sortable" data-sort="media">Média 30d</th>
                                <th class="sortable" data-sort="tier">Tier</th>
                            </tr>
                        </thead>
                        <tbody id="prestadoresTableBody">
                            <tr><td colspan="6" style="text-align:center;color:#999;">Carregando...</td></tr>
                        </tbody>
                    </table>
                    <div class="table-results-info" id="perfResultsInfo"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script>
        // Registrar plugin datalabels
        Chart.register(ChartDataLabels);
        // ==========================================
        // NAVEGAÇÃO SIDEBAR
        // ==========================================
        function navigateTo(section) {
            // Atualizar botões do sidebar
            document.querySelectorAll('.nav-item[data-section]').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`.nav-item[data-section="${section}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Ocultar TODAS as seções primeiro
            const allSections = document.querySelectorAll('.page-section');
            allSections.forEach(sec => {
                sec.classList.remove('active');
                sec.style.display = 'none';
            });

            // Mostrar apenas a seção selecionada
            let targetSection = null;
            if (section === 'funil') {
                targetSection = document.getElementById('sectionFunil');
            } else if (section === 'canais') {
                targetSection = document.getElementById('sectionCanais');
                setTimeout(() => carregarCanais(), 100);
            } else if (section === 'performance') {
                targetSection = document.getElementById('sectionPerformance');
                setTimeout(() => carregarPerformance(), 100);
            } else if (section === 'carteirizacao') {
                targetSection = document.getElementById('sectionCarteirizacao');
                setTimeout(() => carregarCarteirizacao(), 100);
            }

            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
            }

            // Rolar para o topo
            window.scrollTo(0, 0);
            document.querySelector('.main-content').scrollTop = 0;
        }

        // ==========================================
        // CONFIGURAÇÃO METABASE
        // ==========================================
        const METABASE_CONFIG = {
            baseUrl: 'https://metrics.freelaw.work',
            // UUIDs públicos para API sem autenticação (funciona via file://)
            publicUUIDs: {
                area: 'd5cf4a79-5de3-4481-8b6e-5d2f2add6e0b',        // 3474
                ativos: '1b070d81-e824-43e3-ad1a-4882d46a4dea',      // 3622
                tiers: 'de6c2567-00dc-4686-9cea-3e22394f56b9',       // 3697
                funilMaster: '608e08fd-bfc2-45b5-ba64-1c678dc1c21e'  // 3821
            },
            // IDs para referência (não usados diretamente)
            queryAreaId: 3474,
            queryFunilMasterId: 3821,
            queryAtivosId: 3622
        };

        // ==========================================
        // FETCH DATA (API Pública - funciona via file://)
        // ==========================================

        // Ordem fixa dos campos por query (garante consistência)
        const QUERY_FIELD_ORDER = {
            // Query 3622 - Prestadores Ativos
            '1b070d81-e824-43e3-ad1a-4882d46a4dea': [
                'email', 'nome_completo', 'OAB', 'WhatsApp', 'Área', 'Experiência',
                'Nota Prova', 'Acertos Onboarding', 'Média 30d', 'Classificação', 'Tier',
                'Aprovação Prova', 'Aprovação Onboarding', 'Última Sync', '_nocache'
            ],
            // Query 3474 - Funil por Área
            'd5cf4a79-5de3-4481-8b6e-5d2f2add6e0b': [
                'Área de Atuação', 'Inscritos', 'Aprovados Prova', '% Prova',
                'Aprovados Onboarding', '% Onboard', 'Aprovados Total', '% Aprovados',
                'Ativados', 'Taxa Conversão', 'Pendentes Admin', 'Bloqueados',
                'Desativ. Inat.', 'Saída Vol.', 'Desistentes', '_nocache'
            ],
            // Query 3697 - Distribuição por Tier
            'de6c2567-00dc-4686-9cea-3e22394f56b9': [
                'Tier', 'Quantidade', 'Percentual'
            ],
            // Query 3821 - Funil Master Consolidado
            '608e08fd-bfc2-45b5-ba64-1c678dc1c21e': [
                'email', 'oab_numero_uf', 'nome_completo', 'telefone_whatsapp',
                'area_atuacao_principal', 'nota_prova_tecnica', 'prova_finalizada_em',
                'prestador_verificado', 'interesse_alto_volume', 'data_inscricao',
                'como_conheceu', 'is_inscrito', 'is_aprovado', 'is_ativado',
                'is_desativado', 'is_desistente', 'is_bloqueado', 'is_pendente_admin',
                'is_saida_voluntaria', 'status_funil', 'acertos_onboarding',
                'data_aprovacao_onboarding', 'data_verificacao', 'motivo_desativacao',
                'data_desativacao', 'motivo_bloqueio', 'data_bloqueio',
                'motivo_saida', 'data_saida', '_nocache'
            ]
        };

        async function fetchPublicData(uuid) {
            // Usar proxy CORS para evitar bloqueio (mesmo approach do calendario-prestador)
            const corsProxy = 'https://corsproxy.io/?';
            const cacheBuster = `_t=${Date.now()}`;
            const metabaseUrl = `${METABASE_CONFIG.baseUrl}/api/public/card/${uuid}/query/json?${cacheBuster}`;
            const url = corsProxy + encodeURIComponent(metabaseUrl);
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                // API pública retorna array de objetos, converter para array de arrays
                if (data && data.length > 0) {
                    // Usar ordem fixa se definida, senão usar ordem das chaves
                    const fieldOrder = QUERY_FIELD_ORDER[uuid];
                    const keys = fieldOrder || Object.keys(data[0]);
                    console.log(`[fetchPublicData] UUID ${uuid.substring(0,8)}... - Campos: ${keys.slice(0,5).join(', ')}...`);
                    return data.map(row => keys.map(k => row[k]));
                }
                return [];
            } catch (error) {
                console.error(`Erro ao buscar dados públicos (${uuid}):`, error);
                return null;
            }
        }

        // Mapeamento de queryId para UUID público
        function getPublicUUID(queryId) {
            const map = {
                3474: METABASE_CONFIG.publicUUIDs.area,
                3622: METABASE_CONFIG.publicUUIDs.ativos,
                3697: METABASE_CONFIG.publicUUIDs.tiers,
                3821: METABASE_CONFIG.publicUUIDs.funilMaster
            };
            return map[queryId] || null;
        }

        async function fetchMetabaseData(questionId) {
            // Tentar API pública primeiro (funciona via file://)
            const uuid = getPublicUUID(questionId);
            if (uuid) {
                const publicData = await fetchPublicData(uuid);
                if (publicData && publicData.length > 0) {
                    console.log(`[Query ${questionId}] Carregado via API pública: ${publicData.length} registros`);
                    return publicData;
                }
            }

            // Fallback para API autenticada (requer login e localhost)
            const url = `${METABASE_CONFIG.baseUrl}/api/card/${questionId}/query`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return data.data.rows;
            } catch (error) {
                console.error(`Erro ao buscar dados da query ${questionId}:`, error);
                return null;
            }
        }

        // ==========================================
        // PROCESS DATA
        // ==========================================
        function processAreaData(rows) {
            if (!rows) return [];
            return rows.map(row => ({
                area: row[0],
                inscritos: row[1],
                aprovProva: row[2],
                percProva: row[3],
                aprovOnboard: row[4],
                percOnboard: row[5],
                aprovTotal: row[6],
                percAprovados: row[7],
                ativados: row[8],
                taxaConv: row[9],
                pendentes: row[10],
                bloqueados: row[11],
                desativados: row[12],
                saidaVol: row[13],
                desistentes: row[14]
            }));
        }

        function calcularTotais(data) {
            return data.reduce((acc, item) => {
                acc.inscritos += item.inscritos || 0;
                acc.aprovProva += item.aprovProva || 0;
                acc.aprovOnboard += item.aprovOnboard || 0;
                acc.aprovTotal += item.aprovTotal || 0;
                acc.ativados += item.ativados || 0;
                acc.pendentes += item.pendentes || 0;
                acc.bloqueados += item.bloqueados || 0;
                acc.desativados += item.desativados || 0;
                acc.saidaVol += item.saidaVol || 0;
                acc.desistentes += item.desistentes || 0;
                return acc;
            }, {
                inscritos: 0, aprovProva: 0, aprovOnboard: 0, aprovTotal: 0,
                ativados: 0, pendentes: 0, bloqueados: 0, desativados: 0,
                saidaVol: 0, desistentes: 0
            });
        }

        // ==========================================
        // RENDER DASHBOARD
        // ==========================================
        function renderDashboard(totais, ativosCount, tierSCount = 6) {
            // Total Inscritos
            document.getElementById('totalInscritos').textContent = totais.inscritos.toLocaleString('pt-BR');

            // Aprovados
            document.getElementById('totalAprovados').textContent = totais.aprovTotal.toLocaleString('pt-BR');
            const percAprovados = ((totais.aprovTotal / totais.inscritos) * 100).toFixed(1);
            document.getElementById('badgeAprovados').textContent = `${percAprovados}%`;

            // Taxa de Ativação
            const taxaAtivacao = ((totais.ativados / totais.aprovTotal) * 100).toFixed(1);
            document.getElementById('taxaAtivacao').textContent = `${taxaAtivacao}%`;
            document.getElementById('badgeAtivados').textContent = `${totais.ativados.toLocaleString('pt-BR')} ativados`;

            // Ativos Agora
            document.getElementById('ativosAgora').textContent = ativosCount.toLocaleString('pt-BR');

            // Mini Cards
            document.getElementById('pendentesAdmin').textContent = totais.pendentes.toLocaleString('pt-BR');

            // ==================== NOVOS CARDS DASHBOARD ====================
            // Card 1: Total Inscritos
            const totalInscritosCard = document.getElementById('totalInscritosCard');
            if (totalInscritosCard) totalInscritosCard.textContent = totais.inscritos.toLocaleString('pt-BR');

            // Badge aprovados (percentual)
            const badgeAprovadosCard = document.getElementById('badgeAprovadosCard');
            if (badgeAprovadosCard) badgeAprovadosCard.textContent = `${percAprovados}%`;

            // Card 2: Aprovados
            const totalAprovadosCard = document.getElementById('totalAprovadosCard');
            if (totalAprovadosCard) totalAprovadosCard.textContent = totais.aprovTotal.toLocaleString('pt-BR');

            // Card 3: Taxa de Ativação
            const taxaAtivacaoCard = document.getElementById('taxaAtivacaoCard');
            if (taxaAtivacaoCard) taxaAtivacaoCard.textContent = `${taxaAtivacao}%`;

            // Badge ativados
            const badgeAtivadosCard = document.getElementById('badgeAtivadosCard');
            if (badgeAtivadosCard) badgeAtivadosCard.textContent = `${totais.ativados.toLocaleString('pt-BR')} ativados`;

            // Card 4: Ativos Agora
            const ativosAgoraCard = document.getElementById('ativosAgoraCard');
            if (ativosAgoraCard) ativosAgoraCard.textContent = ativosCount.toLocaleString('pt-BR');

            // Mini Cards
            const pendentesAdminCard = document.getElementById('pendentesAdminCard');
            if (pendentesAdminCard) pendentesAdminCard.textContent = totais.pendentes.toLocaleString('pt-BR');

            const bloqueadosCard = document.getElementById('bloqueadosCard');
            if (bloqueadosCard) bloqueadosCard.textContent = totais.bloqueados.toLocaleString('pt-BR');

            const churnTotalCard = document.getElementById('churnTotalCard');
            if (churnTotalCard) churnTotalCard.textContent = (totais.desativados + totais.saidaVol + totais.desistentes).toLocaleString('pt-BR');

            // Update timestamp
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR');
            const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = `Última atualização: ${dateStr} às ${timeStr} • Dados do Supabase`;

            // Atualizar Funil Ampulheta
            const funnelInscritos = totais.inscritos;
            const funnelAprovados = totais.aprovTotal;
            const funnelAtivados = totais.ativados;

            document.getElementById('funnelInscritos').textContent = funnelInscritos.toLocaleString('pt-BR');
            document.getElementById('funnelAprovados').textContent = funnelAprovados.toLocaleString('pt-BR');
            document.getElementById('funnelAprovadosPerc').textContent = ((funnelAprovados / funnelInscritos) * 100).toFixed(1) + '%';
            document.getElementById('funnelAtivados').textContent = funnelAtivados.toLocaleString('pt-BR');
            document.getElementById('funnelAtivadosPerc').textContent = ((funnelAtivados / funnelInscritos) * 100).toFixed(1) + '%';
        }

        // ==========================================
        // FALLBACK DATA
        // ==========================================
        const FALLBACK_DATA = [
            { area: 'Direito Civil', inscritos: 184, aprovProva: 112, aprovOnboard: 106, aprovTotal: 104, ativados: 89, taxaConv: 48.4, pendentes: 19, bloqueados: 9, desativados: 9, saidaVol: 3, desistentes: 3 },
            { area: 'Direito Trabalhista', inscritos: 71, aprovProva: 43, aprovOnboard: 41, aprovTotal: 40, ativados: 35, taxaConv: 49.3, pendentes: 7, bloqueados: 4, desativados: 4, saidaVol: 1, desistentes: 1 },
            { area: 'Direito Previdenciário', inscritos: 25, aprovProva: 15, aprovOnboard: 14, aprovTotal: 14, ativados: 12, taxaConv: 48.0, pendentes: 3, bloqueados: 2, desativados: 1, saidaVol: 1, desistentes: 0 },
            { area: 'Direito Penal', inscritos: 18, aprovProva: 11, aprovOnboard: 10, aprovTotal: 10, ativados: 9, taxaConv: 50.0, pendentes: 2, bloqueados: 1, desativados: 1, saidaVol: 0, desistentes: 0 },
            { area: 'Direito Empresarial', inscritos: 15, aprovProva: 9, aprovOnboard: 8, aprovTotal: 8, ativados: 7, taxaConv: 46.7, pendentes: 1, bloqueados: 1, desativados: 1, saidaVol: 0, desistentes: 0 },
            { area: 'Direito Administrativo', inscritos: 13, aprovProva: 8, aprovOnboard: 7, aprovTotal: 7, ativados: 6, taxaConv: 46.2, pendentes: 2, bloqueados: 0, desativados: 0, saidaVol: 1, desistentes: 0 },
            { area: 'Direito Tributário', inscritos: 14, aprovProva: 9, aprovOnboard: 8, aprovTotal: 8, ativados: 7, taxaConv: 50.0, pendentes: 1, bloqueados: 1, desativados: 1, saidaVol: 0, desistentes: 0 },
            { area: 'Outras áreas', inscritos: 8, aprovProva: 5, aprovOnboard: 6, aprovTotal: 6, ativados: 3, taxaConv: 37.5, pendentes: 1, bloqueados: 0, desativados: 0, saidaVol: 0, desistentes: 1 }
        ];

        // ==========================================
        // LOADING STATE
        // ==========================================
        function mostrarLoading() {
            const totalInscritos = document.getElementById('totalInscritos');
            const totalAprovados = document.getElementById('totalAprovados');
            const taxaAtivacao = document.getElementById('taxaAtivacao');
            const tiersContainer = document.getElementById('tiersContainer');

            if (totalInscritos) totalInscritos.textContent = '...';
            if (totalAprovados) totalAprovados.textContent = '...';
            if (taxaAtivacao) taxaAtivacao.textContent = '...';
            if (tiersContainer) tiersContainer.innerHTML = '<p style="color:#9ca3af;">Carregando...</p>';
        }

        // ==========================================
        // MAIN
        // ==========================================
        async function carregarDados() {
            mostrarLoading();

            try {
                const [areaRows, funilRows, ativosRows] = await Promise.all([
                    fetchMetabaseData(METABASE_CONFIG.queryAreaId),
                    fetchMetabaseData(METABASE_CONFIG.queryFunilMasterId),
                    fetchMetabaseData(METABASE_CONFIG.queryAtivosId)
                ]);

                let areaData, ativosCount, totalInscricoes, totalAprovados, totalAtivos, totalPendentes, totalBloqueados;
                let totalDesativados, totalDesistentes, totalSaidaVol;

                // Só usa fallback se API realmente falhar
                const usarDadosReais = areaRows && areaRows.length > 0 && funilRows && funilRows.length > 0;

                if (usarDadosReais) {
                    areaData = processAreaData(areaRows);
                    totalInscricoes = funilRows.length;
                    totalAprovados = funilRows.filter(r => r[12] === true).length;
                    ativosCount = funilRows.filter(r => r[13] === true).length;
                    totalDesativados = funilRows.filter(r => r[14] === true).length;
                    totalDesistentes = funilRows.filter(r => r[15] === true).length;
                    totalBloqueados = funilRows.filter(r => r[16] === true).length;
                    totalPendentes = funilRows.filter(r => r[17] === true).length;
                    totalSaidaVol = funilRows.filter(r => r[18] === true).length;
                    totalAtivos = ativosRows ? ativosRows.length : ativosCount;
                } else {
                    console.warn('API indisponível - usando fallback');
                    areaData = FALLBACK_DATA;
                    ativosCount = 168;
                    totalInscricoes = 348;
                    totalAprovados = 212;
                    totalAtivos = 168;
                    totalPendentes = 36;
                    totalBloqueados = 18;
                    totalDesativados = 17;
                    totalDesistentes = 5;
                    totalSaidaVol = 6;
                }

                const totais = calcularTotais(areaData);

                // Sobrescrever com dados consolidados
                totais.inscritos = totalInscricoes;
                totais.aprovProva = totalAprovados;
                totais.ativados = ativosCount;
                totais.pendentes = totalPendentes;
                totais.bloqueados = totalBloqueados;
                totais.desativados = totalDesativados;
                totais.desistentes = totalDesistentes;
                totais.saidaVol = totalSaidaVol;

                // Calcular Churn Total
                totais.churnTotal = (totais.bloqueados || 0) + (totais.desativados || 0) +
                                   (totais.desistentes || 0) + (totais.saidaVol || 0);

                console.log(`[Dados ${usarDadosReais ? 'API' : 'Fallback'}] Inscrições: ${totalInscricoes}, Aprovados: ${totalAprovados}, Ativos: ${totalAtivos}`);

                renderDashboard(totais, ativosCount);

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                const totais = calcularTotais(FALLBACK_DATA);
                totais.inscritos = 348;
                totais.aprovProva = 212;
                totais.ativados = 168;
                totais.churnTotal = 46;
                renderDashboard(totais, 168);
            }
        }

        // ==========================================
        // SEGMENTAÇÃO POR TIER - Query 3697
        // ==========================================
        const TIER_CONFIG = {
            queryId: 3697
        };

        const TIER_FALLBACK = [
            ['Tier S', 6, 4.9],
            ['Tier A', 3, 2.4],
            ['Tier B', 4, 3.3],
            ['Tier C', 2, 1.6],
            ['Tier D', 8, 6.5],
            ['Onboarding', 93, 75.6],
            ['Inativo', 7, 5.7]
        ];

        async function carregarTiers() {
            try {
                const rows = await fetchMetabaseData(TIER_CONFIG.queryId);
                if (rows && rows.length > 0) {
                    renderTierData(rows);
                } else {
                    console.log('Usando fallback para Tiers');
                    renderTierData(TIER_FALLBACK);
                }
            } catch (error) {
                console.error('Erro ao carregar tiers:', error);
                renderTierData(TIER_FALLBACK);
            }
        }

        function renderTierData(rows) {
            const tierMap = {};
            let total = 0;

            rows.forEach(row => {
                const tier = row[0];
                const count = row[1];
                const perc = row[2];
                tierMap[tier] = { count, perc };
                total += count;
            });

            // Atualizar cards de tier e funil ampulheta
            if (tierMap['Tier S']) {
                document.getElementById('tierSCount').textContent = tierMap['Tier S'].count;
                document.getElementById('tierSPerc').textContent = tierMap['Tier S'].perc + '%';
                document.getElementById('barTierS').style.width = tierMap['Tier S'].perc + '%';
                document.getElementById('barTierS').title = 'Tier S: ' + tierMap['Tier S'].count;
                // Funil
                if (document.getElementById('funnelTierS')) {
                    document.getElementById('funnelTierS').textContent = tierMap['Tier S'].count;
                    document.getElementById('funnelTierSPerc').textContent = tierMap['Tier S'].perc + '%';
                }
            }
            if (tierMap['Tier A']) {
                document.getElementById('tierACount').textContent = tierMap['Tier A'].count;
                document.getElementById('tierAPerc').textContent = tierMap['Tier A'].perc + '%';
                document.getElementById('barTierA').style.width = tierMap['Tier A'].perc + '%';
                document.getElementById('barTierA').title = 'Tier A: ' + tierMap['Tier A'].count;
                // Funil
                if (document.getElementById('funnelTierA')) {
                    document.getElementById('funnelTierA').textContent = tierMap['Tier A'].count;
                    document.getElementById('funnelTierAPerc').textContent = tierMap['Tier A'].perc + '%';
                }
            }
            if (tierMap['Tier B']) {
                document.getElementById('tierBCount').textContent = tierMap['Tier B'].count;
                document.getElementById('tierBPerc').textContent = tierMap['Tier B'].perc + '%';
                document.getElementById('barTierB').style.width = tierMap['Tier B'].perc + '%';
                document.getElementById('barTierB').title = 'Tier B: ' + tierMap['Tier B'].count;
                // Funil
                if (document.getElementById('funnelTierB')) {
                    document.getElementById('funnelTierB').textContent = tierMap['Tier B'].count;
                    document.getElementById('funnelTierBPerc').textContent = tierMap['Tier B'].perc + '%';
                }
            }
            if (tierMap['Tier C']) {
                document.getElementById('tierCCount').textContent = tierMap['Tier C'].count;
                document.getElementById('tierCPerc').textContent = tierMap['Tier C'].perc + '%';
                document.getElementById('barTierC').style.width = tierMap['Tier C'].perc + '%';
                document.getElementById('barTierC').title = 'Tier C: ' + tierMap['Tier C'].count;
                // Funil
                if (document.getElementById('funnelTierC')) {
                    document.getElementById('funnelTierC').textContent = tierMap['Tier C'].count;
                    document.getElementById('funnelTierCPerc').textContent = tierMap['Tier C'].perc + '%';
                }
            }
            if (tierMap['Tier D']) {
                document.getElementById('tierDCount').textContent = tierMap['Tier D'].count;
                document.getElementById('tierDPerc').textContent = tierMap['Tier D'].perc + '%';
                document.getElementById('barTierD').style.width = tierMap['Tier D'].perc + '%';
                document.getElementById('barTierD').title = 'Tier D: ' + tierMap['Tier D'].count;
                // Funil
                if (document.getElementById('funnelTierD')) {
                    document.getElementById('funnelTierD').textContent = tierMap['Tier D'].count;
                    document.getElementById('funnelTierDPerc').textContent = tierMap['Tier D'].perc + '%';
                }
            }
            if (tierMap['Onboarding']) {
                document.getElementById('tierOnboardingCount').textContent = tierMap['Onboarding'].count;
                document.getElementById('tierOnboardingPerc').textContent = tierMap['Onboarding'].perc + '%';
                document.getElementById('barOnboarding').style.width = tierMap['Onboarding'].perc + '%';
                document.getElementById('barOnboarding').textContent = 'Onboarding (' + tierMap['Onboarding'].count + ')';
                document.getElementById('barOnboarding').title = 'Onboarding: ' + tierMap['Onboarding'].count;
            }
            if (tierMap['Inativo']) {
                document.getElementById('tierInativoCount').textContent = tierMap['Inativo'].count;
                document.getElementById('tierInativoPerc').textContent = tierMap['Inativo'].perc + '%';
                document.getElementById('barInativo').style.width = tierMap['Inativo'].perc + '%';
                document.getElementById('barInativo').title = 'Inativo: ' + tierMap['Inativo'].count;
            }

            // Atualizar totais
            document.getElementById('totalAtivadosTier').textContent = total.toLocaleString('pt-BR');
            // Atualizar funnelAtivos no centro da ampulheta
            if (document.getElementById('funnelAtivos')) {
                document.getElementById('funnelAtivos').textContent = total.toLocaleString('pt-BR');
            }

            // Calcular total com Tier (S-D)
            const totalComTier = (tierMap['Tier S']?.count || 0) +
                                 (tierMap['Tier A']?.count || 0) +
                                 (tierMap['Tier B']?.count || 0) +
                                 (tierMap['Tier C']?.count || 0) +
                                 (tierMap['Tier D']?.count || 0);
            document.getElementById('totalComTier').textContent = totalComTier.toLocaleString('pt-BR');
            // Percentagem do tier em relação aos ativos
            if (document.getElementById('tierPercTotal') && total > 0) {
                const tierPerc = ((totalComTier / total) * 100).toFixed(1);
                document.getElementById('tierPercTotal').textContent = tierPerc + '%';
            }
        }

        // ==========================================
        // INICIALIZAÇÃO - Carrega dados após DOM pronto
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            mostrarLoading();
            await Promise.all([
                carregarDados(),
                carregarTiers()
            ]);
        });

        // ==========================================
        // CANAIS DE ENTRADA - Query 3821 (consolidada)
        // ==========================================
        const CANAIS_CONFIG = {
            queryId: 3821, // Query consolidada do funil
            // Mapeamento de campos da query 3821
            fields: {
                email: 0,
                oab_numero_uf: 1,
                nome_completo: 2,
                telefone_whatsapp: 3,
                area_atuacao_principal: 4,
                nota_prova_tecnica: 5,
                prova_finalizada_em: 6,
                prestador_verificado: 7,
                interesse_alto_volume: 8,
                data_inscricao: 9,
                como_conheceu: 10
            }
        };

        const CANAIS_FALLBACK = {
            instagram: 89,
            linkedin: 78,
            google: 52,
            indicacao: 98,
            outros: 28
        };

        const AREAS_POR_CANAL_FALLBACK = [
            { area: 'Direito Civil', instagram: 28, linkedin: 22, google: 15, indicacao: 32, outros: 8 },
            { area: 'Trabalhista', instagram: 18, linkedin: 16, google: 12, indicacao: 21, outros: 6 },
            { area: 'Previdenciário', instagram: 15, linkedin: 12, google: 8, indicacao: 16, outros: 5 },
            { area: 'Penal', instagram: 10, linkedin: 8, google: 6, indicacao: 11, outros: 3 },
            { area: 'Empresarial', instagram: 8, linkedin: 10, google: 5, indicacao: 9, outros: 3 },
            { area: 'Tributário', instagram: 5, linkedin: 6, google: 4, indicacao: 5, outros: 2 },
            { area: 'Administrativo', instagram: 5, linkedin: 4, google: 2, indicacao: 4, outros: 1 }
        ];

        let chartDistribuicao = null;
        let chartConversao = null;
        let chartEvolucao = null;

        function normalizeCanal(canal) {
            if (!canal) return 'Outros';
            const c = canal.toLowerCase().trim();
            if (c.includes('instagram')) return 'Instagram';
            if (c.includes('linkedin')) return 'LinkedIn';
            if (c.includes('google') || c.includes('busca')) return 'Google';
            if (c.includes('indica')) return 'Indicação';
            return 'Outros';
        }

        function processCanaisData(rows) {
            const canais = { Instagram: 0, LinkedIn: 0, Google: 0, 'Indicação': 0, Outros: 0 };
            const canaisAprovados = { Instagram: 0, LinkedIn: 0, Google: 0, 'Indicação': 0, Outros: 0 };
            const areasPorCanal = {};
            const evolucaoMensal = {}; // { 'Out/24': { Instagram: 5, ... }, ... }

            rows.forEach(row => {
                const canalOriginal = row[CANAIS_CONFIG.fields.como_conheceu];
                const canal = normalizeCanal(canalOriginal);
                const area = row[CANAIS_CONFIG.fields.area_atuacao_principal] || 'Não informado';
                const nota = row[CANAIS_CONFIG.fields.nota_prova_tecnica];
                const dataInscricao = row[CANAIS_CONFIG.fields.data_inscricao];
                const aprovado = nota !== null && nota >= 7;

                canais[canal]++;
                if (aprovado) canaisAprovados[canal]++;

                if (!areasPorCanal[area]) {
                    areasPorCanal[area] = { Instagram: 0, LinkedIn: 0, Google: 0, 'Indicação': 0, Outros: 0 };
                }
                areasPorCanal[area][canal]++;

                // Processar evolução mensal (usa data de inscrição)
                if (dataInscricao) {
                    const date = new Date(dataInscricao);
                    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                    const mesAno = `${meses[date.getMonth()]}/${String(date.getFullYear()).slice(-2)}`;

                    if (!evolucaoMensal[mesAno]) {
                        evolucaoMensal[mesAno] = { Instagram: 0, LinkedIn: 0, Google: 0, 'Indicação': 0, Outros: 0 };
                    }
                    evolucaoMensal[mesAno][canal]++;
                }
            });

            return { canais, canaisAprovados, areasPorCanal, evolucaoMensal, total: rows.length };
        }

        // Configuração dos ícones SVG de cada canal
        const CHANNEL_ICONS = {
            Instagram: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>',
            LinkedIn: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>',
            Google: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/></svg>',
            'Indicação': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
            Outros: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"/></svg>'
        };

        const CHANNEL_CLASSES = {
            Instagram: 'instagram',
            LinkedIn: 'linkedin',
            Google: 'google',
            'Indicação': 'indicacao',
            Outros: 'outros'
        };

        function renderCanaisCards(data) {
            const { canais, total } = data;
            const container = document.getElementById('channelCardsContainer');

            // Converter para array e ordenar do maior para menor
            const canaisOrdenados = Object.entries(canais)
                .map(([nome, count]) => ({ nome, count, perc: ((count / total) * 100).toFixed(1) }))
                .sort((a, b) => b.count - a.count);

            // Renderizar cards ordenados
            container.innerHTML = canaisOrdenados.map(({ nome, count, perc }) => `
                <div class="channel-card ${CHANNEL_CLASSES[nome] || 'outros'}">
                    <div class="channel-icon">
                        ${CHANNEL_ICONS[nome] || CHANNEL_ICONS.Outros}
                    </div>
                    <div class="channel-info">
                        <span class="channel-name">${nome}</span>
                        <span class="channel-count">${count.toLocaleString('pt-BR')}</span>
                    </div>
                    <span class="channel-percent">${perc}%</span>
                </div>
            `).join('');
        }

        function renderCharts(data) {
            const { canais, canaisAprovados } = data;
            const labels = ['Instagram', 'LinkedIn', 'Google', 'Indicação', 'Outros'];
            // Cores Freelaw
            const colors = ['#DD2869', '#241054', '#ECB43D', '#5527AD', '#A994E6'];
            const values = labels.map(l => canais[l] || 0);
            const aprovados = labels.map(l => canaisAprovados[l] || 0);
            const taxas = values.map((v, i) => v > 0 ? ((aprovados[i] / v) * 100).toFixed(1) : 0);

            // Gráfico de Distribuição (Doughnut)
            const ctxDist = document.getElementById('chartDistribuicao').getContext('2d');
            if (chartDistribuicao) chartDistribuicao.destroy();
            chartDistribuicao = new Chart(ctxDist, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { font: { size: 12 }, padding: 16 }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    }
                }
            });

            // Gráfico de Conversão (Bar)
            const ctxConv = document.getElementById('chartConversao').getContext('2d');
            if (chartConversao) chartConversao.destroy();
            chartConversao = new Chart(ctxConv, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Taxa de Aprovação (%)',
                        data: taxas,
                        backgroundColor: colors.map(c => c + 'CC'),
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#1F1F3D',
                            anchor: 'end',
                            align: 'top',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value) => value > 0 ? value + '%' : ''
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }

        function renderAreasTable(data) {
            const { areasPorCanal } = data;
            const tbody = document.getElementById('areasTableBody');

            // Ordenar áreas por total
            const areasOrdenadas = Object.entries(areasPorCanal)
                .map(([area, canais]) => ({
                    area,
                    ...canais,
                    total: Object.values(canais).reduce((a, b) => a + b, 0)
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10); // Top 10 áreas

            tbody.innerHTML = areasOrdenadas.map(row => `
                <tr>
                    <td>${row.area}</td>
                    <td>${row.Instagram || 0}</td>
                    <td>${row.LinkedIn || 0}</td>
                    <td>${row.Google || 0}</td>
                    <td>${row['Indicação'] || 0}</td>
                    <td>${row.Outros || 0}</td>
                    <td>${row.total}</td>
                </tr>
            `).join('');
        }

        function renderChartEvolucao(data) {
            const { evolucaoMensal } = data;

            // Ordenar meses cronologicamente
            const mesesOrdem = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const labels = Object.keys(evolucaoMensal).sort((a, b) => {
                const [mesA, anoA] = a.split('/');
                const [mesB, anoB] = b.split('/');
                if (anoA !== anoB) return parseInt(anoA) - parseInt(anoB);
                return mesesOrdem.indexOf(mesA) - mesesOrdem.indexOf(mesB);
            });

            const canaisNomes = ['Instagram', 'LinkedIn', 'Google', 'Indicação', 'Outros'];
            // Cores Freelaw
            const colors = ['#DD2869', '#241054', '#ECB43D', '#5527AD', '#A994E6'];

            const datasets = canaisNomes.map((canal, i) => ({
                label: canal,
                data: labels.map(mes => evolucaoMensal[mes]?.[canal] || 0),
                borderColor: colors[i],
                backgroundColor: colors[i] + '20',
                borderWidth: 2,
                tension: 0.3,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            }));

            const ctx = document.getElementById('chartEvolucao').getContext('2d');
            if (chartEvolucao) chartEvolucao.destroy();

            chartEvolucao = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { font: { size: 12 }, padding: 16, usePointStyle: true }
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => `Mês: ${items[0].label}`,
                                footer: (items) => {
                                    const total = items.reduce((sum, item) => sum + item.raw, 0);
                                    return `Total: ${total} inscrições`;
                                }
                            }
                        },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 10 },
                            title: { display: true, text: 'Inscrições' }
                        },
                        x: {
                            title: { display: true, text: 'Mês/Ano' }
                        }
                    }
                }
            });
        }

        async function carregarCanais() {
            try {
                const rows = await fetchMetabaseData(CANAIS_CONFIG.queryId);

                if (rows && rows.length > 0) {
                    const data = processCanaisData(rows);
                    renderCanaisCards(data);
                    renderCharts(data);
                    renderChartEvolucao(data);
                    renderAreasTable(data);
                } else {
                    console.log('Usando dados de fallback para canais');
                    usarFallbackCanais();
                }
            } catch (error) {
                console.error('Erro ao carregar canais:', error);
                usarFallbackCanais();
            }
        }

        function usarFallbackCanais() {
            const canais = CANAIS_FALLBACK;
            const total = Object.values(canais).reduce((a, b) => a + b, 0);

            const canaisAprovados = {
                Instagram: Math.round(canais.instagram * 0.55),
                LinkedIn: Math.round(canais.linkedin * 0.65),
                Google: Math.round(canais.google * 0.60),
                'Indicação': Math.round(canais.indicacao * 0.70),
                Outros: Math.round(canais.outros * 0.50)
            };

            const evolucaoMensal = {
                'Out/25': { Instagram: 30, LinkedIn: 25, Google: 18, 'Indicação': 35, Outros: 10 },
                'Nov/25': { Instagram: 35, LinkedIn: 30, Google: 20, 'Indicação': 38, Outros: 12 },
                'Dez/25': { Instagram: 24, LinkedIn: 23, Google: 14, 'Indicação': 25, Outros: 6 }
            };

            const data = {
                canais: {
                    Instagram: canais.instagram,
                    LinkedIn: canais.linkedin,
                    Google: canais.google,
                    'Indicação': canais.indicacao,
                    Outros: canais.outros
                },
                canaisAprovados,
                areasPorCanal: AREAS_POR_CANAL_FALLBACK.reduce((acc, row) => {
                    acc[row.area] = {
                        Instagram: row.instagram,
                        LinkedIn: row.linkedin,
                        Google: row.google,
                        'Indicação': row.indicacao,
                        Outros: row.outros
                    };
                    return acc;
                }, {}),
                evolucaoMensal,
                total
            };

            renderCanaisCards(data);
            renderCharts(data);
            renderChartEvolucao(data);
            renderAreasTable(data);
        }

        // Carregar canais após Chart.js estar disponível
        if (typeof Chart !== 'undefined') {
            console.log('Chart.js disponível, carregando canais...');
            carregarCanais();
        } else {
            console.log('Aguardando Chart.js...');
            window.addEventListener('load', carregarCanais);
        }

        // ==========================================
        // PERFORMANCE - Query 3622
        // ==========================================
        const PERFORMANCE_CONFIG = {
            queryId: 3622,
            fields: { email: 0, nome: 1, oab: 2, whatsapp: 3, area: 4, experiencia: 5, notaProva: 6, acertosOnboarding: 7, media30d: 8, classificacao: 9, tier: 10 }
        };

        // Dados carregados dinamicamente do Metabase (query 3622) - SEM FALLBACK
        // Fonte: https://metrics.freelaw.work/question/3622-prestadores-ativos-inscricoes-comunidade
        // Este array é preenchido em tempo real via API do Metabase
        let CARTEIRIZACAO_DATA = []; // Array vazio - dados vêm do Metabase

        // Dados de Performance carregados exclusivamente via API pública do Metabase
        // Nenhum fallback - se a API falhar, mostra mensagem de erro

        let chartTiers = null;
        let chartAreas = null;
        let performanceLoaded = false;

        function processPerformanceData(rows) {
            const tiers = {}, areas = {};
            let somaNotas = 0, somaMedia30d = 0, countNotas = 0, countMedia = 0;

            rows.forEach(row => {
                const tier = row[PERFORMANCE_CONFIG.fields.tier] || 'Não definido';
                const area = row[PERFORMANCE_CONFIG.fields.area] || 'Não informado';
                const nota = row[PERFORMANCE_CONFIG.fields.notaProva];
                const media30d = row[PERFORMANCE_CONFIG.fields.media30d];

                tiers[tier] = (tiers[tier] || 0) + 1;
                areas[area] = (areas[area] || 0) + 1;

                if (nota !== null && nota > 0) { somaNotas += parseFloat(nota); countNotas++; }
                if (media30d !== null && media30d > 0) { somaMedia30d += parseFloat(media30d); countMedia++; }
            });

            return { total: rows.length, tiers, areas, mediaNota: countNotas > 0 ? (somaNotas / countNotas).toFixed(1) : '--', mediaMedia30d: countMedia > 0 ? (somaMedia30d / countMedia).toFixed(1) : '--', totalAreas: Object.keys(areas).length, rows };
        }

        function renderPerformanceKPIs(data) {
            document.getElementById('perfTotalAtivos').textContent = data.total.toLocaleString('pt-BR');
            document.getElementById('totalPrestadoresAtivos').textContent = `${data.total} prestadores`;
            document.getElementById('perfMedia30d').textContent = data.mediaMedia30d;
            document.getElementById('perfTotalAreas').textContent = data.totalAreas;
        }

        function renderPerformanceCharts(data) {
            const tierColors = { 'Tier S': '#241054', 'Tier A': '#5527AD', 'Tier B': '#DD2869', 'Tier C': '#ECB43D', 'Tier D': '#000000', 'Onboarding': '#A994E6', 'Inativo': '#6B7280', 'Não definido': '#D1D5DB' };

            const ctxTiers = document.getElementById('chartTiers').getContext('2d');
            if (chartTiers) chartTiers.destroy();
            chartTiers = new Chart(ctxTiers, {
                type: 'doughnut',
                data: { labels: Object.keys(data.tiers).sort(), datasets: [{ data: Object.keys(data.tiers).sort().map(t => data.tiers[t]), backgroundColor: Object.keys(data.tiers).sort().map(t => tierColors[t] || '#6B7280'), borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 12 }, padding: 16 } }, datalabels: { color: '#fff', font: { weight: 'bold', size: 13 }, formatter: (value) => value > 0 ? value : '' } } }
            });

            const ctxAreas = document.getElementById('chartAreas').getContext('2d');
            if (chartAreas) chartAreas.destroy();
            const areasSorted = Object.entries(data.areas).sort((a, b) => b[1] - a[1]).slice(0, 8);
            chartAreas = new Chart(ctxAreas, {
                type: 'bar',
                data: { labels: areasSorted.map(a => a[0]), datasets: [{ label: 'Prestadores', data: areasSorted.map(a => a[1]), backgroundColor: '#A994E6', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false }, datalabels: { display: false } }, scales: { x: { beginAtZero: true } } }
            });
        }

        // Gráfico de Atividade 30 dias
        let chartAtividade30d = null;

        function renderAtividade30dChart(rows) {
            // Contar quantos pegaram e não pegaram serviço
            let pegaram = 0;
            let naoPegaram = 0;

            rows.forEach(row => {
                const classificacao = row[9]; // Coluna "Classificação"
                if (classificacao && classificacao.includes('Pegou serviço')) {
                    pegaram++;
                } else {
                    naoPegaram++;
                }
            });

            const total = pegaram + naoPegaram;
            const percentual = total > 0 ? ((pegaram / total) * 100).toFixed(1) : 0;

            // Atualizar indicadores
            document.getElementById('percAtivos30d').textContent = `${percentual}%`;
            document.getElementById('qtdAtivos30d').textContent = pegaram;
            document.getElementById('qtdInativos30d').textContent = naoPegaram;

            // Renderizar gráfico de pizza
            const ctx = document.getElementById('chartAtividade30d');
            if (ctx) {
                if (chartAtividade30d) chartAtividade30d.destroy();
                chartAtividade30d = new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Pegaram serviço', 'Não pegaram'],
                        datasets: [{
                            data: [pegaram, naoPegaram],
                            backgroundColor: ['#ECB43D', '#DD2869'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { size: 12 }, padding: 16 }
                            },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold', size: 14 },
                                formatter: (value, ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const perc = ((value / total) * 100).toFixed(0);
                                    return value > 0 ? `${value}\n(${perc}%)` : '';
                                }
                            }
                        }
                    }
                });
            }
        }

        // Dados globais para filtros e ordenação
        let perfTableData = [];
        let perfSortColumn = 'nome';
        let perfSortDirection = 'asc';

        function renderPrestadoresTable(data) {
            // Armazenar dados para filtros
            perfTableData = data.rows.map(row => ({
                nome: row[1] || '',
                email: row[0] || '',
                oab: row[2] || '',
                area: row[4] || '',
                media: row[8] !== null ? parseFloat(row[8]) : null,
                tier: row[10] || 'Onboarding'
            }));

            // Renderizar tabela
            applyPerfFilters();

            // Adicionar event listeners
            setupPerfTableListeners();
        }

        function setupPerfTableListeners() {
            // Busca
            document.getElementById('perfSearch')?.addEventListener('input', applyPerfFilters);

            // Filtros
            document.getElementById('perfFilterArea')?.addEventListener('change', applyPerfFilters);
            document.getElementById('perfFilterTier')?.addEventListener('change', applyPerfFilters);

            // Ordenação
            document.querySelectorAll('#perfTable th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (perfSortColumn === column) {
                        perfSortDirection = perfSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        perfSortColumn = column;
                        perfSortDirection = 'asc';
                    }
                    updateSortIndicators();
                    applyPerfFilters();
                });
            });
        }

        function updateSortIndicators() {
            document.querySelectorAll('#perfTable th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sort === perfSortColumn) {
                    th.classList.add(perfSortDirection);
                }
            });
        }

        function applyPerfFilters() {
            const searchTerm = (document.getElementById('perfSearch')?.value || '').toLowerCase();
            const areaFilter = document.getElementById('perfFilterArea')?.value || '';
            const tierFilter = document.getElementById('perfFilterTier')?.value || '';

            // Filtrar
            let filtered = perfTableData.filter(row => {
                const matchSearch = !searchTerm ||
                    row.nome.toLowerCase().includes(searchTerm) ||
                    row.oab.toLowerCase().includes(searchTerm);
                const matchArea = !areaFilter || row.area.includes(areaFilter);
                const matchTier = !tierFilter || row.tier === tierFilter;
                return matchSearch && matchArea && matchTier;
            });

            // Ordenar
            filtered.sort((a, b) => {
                let valA, valB;
                switch (perfSortColumn) {
                    case 'nome': valA = a.nome; valB = b.nome; break;
                    case 'oab': valA = a.oab; valB = b.oab; break;
                    case 'area': valA = a.area; valB = b.area; break;
                    case 'media': valA = a.media ?? -1; valB = b.media ?? -1; break;
                    case 'tier':
                        const tierOrder = { 'S': 1, 'A': 2, 'B': 3, 'C': 4, 'D': 5, 'Onboarding': 6 };
                        valA = tierOrder[a.tier] || 99;
                        valB = tierOrder[b.tier] || 99;
                        break;
                    default: valA = a.nome; valB = b.nome;
                }

                if (typeof valA === 'string') {
                    return perfSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
                return perfSortDirection === 'asc' ? valA - valB : valB - valA;
            });

            // Renderizar
            const tbody = document.getElementById('prestadoresTableBody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px;">Nenhum prestador encontrado</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(row => `
                    <tr>
                        <td>${row.nome || '--'}</td>
                        <td style="font-size: 0.85rem;">${row.email || '--'}</td>
                        <td>${row.oab || '--'}</td>
                        <td>${row.area || '--'}</td>
                        <td>${row.media !== null ? row.media.toFixed(1) : '--'}</td>
                        <td><span class="tier-badge tier-${row.tier.toLowerCase()}">${row.tier}</span></td>
                    </tr>
                `).join('');
            }

            // Info de resultados
            const info = document.getElementById('perfResultsInfo');
            if (info) {
                info.textContent = `Exibindo ${filtered.length} de ${perfTableData.length} prestadores`;
            }
        }

        async function carregarPerformance() {
            if (performanceLoaded) return;

            // Buscar dados da query 3622 se ainda não carregados
            if (CARTEIRIZACAO_DATA.length === 0) {
                try {
                    document.getElementById('lastUpdatePerf').textContent = 'Carregando Query 3622...';
                    const rows = await fetchMetabaseData(METABASE_CONFIG.queryAtivosId);
                    if (rows && rows.length > 0) {
                        CARTEIRIZACAO_DATA = rows;
                        console.log(`[Query 3622] Carregados ${rows.length} prestadores ativos`);
                    } else {
                        console.warn('[Query 3622] Nenhum dado retornado.');
                        document.getElementById('lastUpdatePerf').textContent = 'Erro: Faça login no Metabase e recarregue';
                        return;
                    }
                } catch (error) {
                    console.error('[Query 3622] Erro:', error);
                    document.getElementById('lastUpdatePerf').textContent = 'Erro ao carregar dados';
                    return;
                }
            }

            if (CARTEIRIZACAO_DATA.length === 0) return;

            const data = processPerformanceData(CARTEIRIZACAO_DATA);
            renderPerformanceKPIs(data);
            renderPerformanceCharts(data);
            renderPrestadoresTable(data);
            renderAtividade30dChart(CARTEIRIZACAO_DATA);
            document.getElementById('lastUpdatePerf').textContent = 'Query 3622 • ' + CARTEIRIZACAO_DATA.length + ' prestadores ativos';
            performanceLoaded = true;
        }

        // ==========================================
        // CARTEIRIZAÇÃO - Segmentação por Nota Média (Qualidade)
        // ==========================================
        let carteirizacaoLoaded = false;
        let carteirizacaoData = [];
        let carteirizacaoFiltroAtual = 'todos';
        let chartCarteirizacao = null;

        function classificarPrestadorPorQualidade(row) {
            const media30d = row[8] !== null ? parseFloat(row[8]) : 0;

            // Sem avaliação: média = 0 (nunca recebeu avaliação)
            if (media30d === 0) {
                return { segmento: 'semavaliacao', label: 'Sem Avaliação', cor: '#DD2869' };
            }
            // Alta Performance: média >= 4.5
            else if (media30d >= 4.5) {
                return { segmento: 'alta', label: 'Alta Performance', cor: '#22C55E' };
            }
            // Bom Desempenho: média entre 4.0 e 4.49
            else if (media30d >= 4.0) {
                return { segmento: 'bom', label: 'Bom Desempenho', cor: '#3B82F6' };
            }
            // Em Desenvolvimento: média < 4.0
            else {
                return { segmento: 'desenvolvimento', label: 'Em Desenvolvimento', cor: '#ECB43D' };
            }
        }

        function processarCarteirizacao(rows) {
            const contadores = { alta: 0, bom: 0, desenvolvimento: 0, semavaliacao: 0 };

            carteirizacaoData = rows.map(row => {
                const classificacaoObj = classificarPrestadorPorQualidade(row);
                contadores[classificacaoObj.segmento]++;
                return {
                    segmento: classificacaoObj.segmento,
                    label: classificacaoObj.label,
                    cor: classificacaoObj.cor,
                    email: row[0] || '',
                    nome: row[1] || '',
                    oab: row[2] || '',
                    whatsapp: row[3] || '',
                    area: row[4] || '',
                    experiencia: row[5] || '',
                    notaProva: row[6] !== null ? parseFloat(row[6]) : null,
                    acertosOnboarding: row[7] !== null ? parseInt(row[7]) : null,
                    media30d: row[8] !== null ? parseFloat(row[8]) : 0,
                    classificacao: row[9] || '',
                    tier: row[10] || 'Onboarding'
                };
            });

            return contadores;
        }

        function renderCarteirizacaoCards(contadores) {
            const total = contadores.alta + contadores.bom + contadores.desenvolvimento + contadores.semavaliacao;
            document.getElementById('countAlta').textContent = contadores.alta;
            document.getElementById('countBom').textContent = contadores.bom;
            document.getElementById('countDesenvolvimento').textContent = contadores.desenvolvimento;
            document.getElementById('countSemAvaliacao').textContent = contadores.semavaliacao;
            document.getElementById('totalPrestadoresCarteira').textContent = total;

            // Atualizar contadores nas ações
            document.getElementById('countAltaAcao').textContent = contadores.alta;
            document.getElementById('countBomAcao').textContent = contadores.bom;
            document.getElementById('countDesenvolvimentoAcao').textContent = contadores.desenvolvimento;
            document.getElementById('countSemAvaliacaoAcao').textContent = contadores.semavaliacao;
        }

        function renderCarteirizacaoChart(contadores) {
            const ctx = document.getElementById('chartCarteirizacao');
            if (!ctx) return;

            if (chartCarteirizacao) chartCarteirizacao.destroy();

            const total = contadores.alta + contadores.bom + contadores.desenvolvimento + contadores.semavaliacao;

            // Plugin para mostrar total no centro
            const centerTextPlugin = {
                id: 'centerText',
                beforeDraw: function(chart) {
                    if (chart.canvas.id !== 'chartCarteirizacao') return;
                    const ctx = chart.ctx;
                    const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                    const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;

                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // Número grande
                    ctx.font = 'bold 2.5rem -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.fillStyle = '#1F1F3D';
                    ctx.fillText(total, centerX, centerY - 10);

                    // Label "PRESTADORES"
                    ctx.font = '600 0.65rem -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.fillStyle = '#9CA3AF';
                    ctx.fillText('PRESTADORES', centerX, centerY + 20);

                    ctx.restore();
                }
            };

            chartCarteirizacao = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Alta Perf.', 'Bom Desemp.', 'Em Desenv.', 'Sem Aval.'],
                    datasets: [{
                        data: [contadores.alta, contadores.bom, contadores.desenvolvimento, contadores.semavaliacao],
                        backgroundColor: ['#22C55E', '#3B82F6', '#ECB43D', '#DD2869'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 11 },
                                padding: 16,
                                usePointStyle: true,
                                pointStyle: 'rectRounded'
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    }
                },
                plugins: [centerTextPlugin]
            });
        }

        function renderCarteirizacaoTable(filtro = 'todos') {
            const tbody = document.getElementById('carteirizacaoTableBody');
            const searchTerm = (document.getElementById('carteirizacaoSearch')?.value || '').toLowerCase();
            const areaFilter = document.getElementById('carteirizacaoArea')?.value || '';

            let filtered = carteirizacaoData.filter(p => {
                const matchSegmento = filtro === 'todos' || p.segmento === filtro;
                const matchSearch = !searchTerm || p.nome.toLowerCase().includes(searchTerm) || p.oab.toLowerCase().includes(searchTerm);
                const matchArea = !areaFilter || p.area.includes(areaFilter);
                return matchSegmento && matchSearch && matchArea;
            });

            // Ordenar por média (maior primeiro), depois por segmento
            const ordem = { alta: 0, bom: 1, desenvolvimento: 2, semavaliacao: 3 };
            filtered.sort((a, b) => {
                if (ordem[a.segmento] !== ordem[b.segmento]) {
                    return ordem[a.segmento] - ordem[b.segmento];
                }
                return b.media30d - a.media30d; // Maior média primeiro dentro do segmento
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">Nenhum prestador encontrado</td></tr>';
            } else {
                tbody.innerHTML = filtered.map(p => `
                    <tr>
                        <td><span style="background: ${p.cor}20; color: ${p.cor}; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${p.label}</span></td>
                        <td style="font-weight: 600;">${p.nome}</td>
                        <td><a href="mailto:${p.email}" style="color: #7C3AED; font-size: 0.85rem;">${p.email}</a></td>
                        <td>${p.oab}</td>
                        <td>${p.area}</td>
                        <td><span class="tier-badge tier-${p.tier.toLowerCase().replace(' ', '-')}">${p.tier}</span></td>
                        <td style="font-weight: 600; color: ${p.media30d >= 4.5 ? '#22C55E' : p.media30d >= 4.0 ? '#3B82F6' : p.media30d > 0 ? '#ECB43D' : '#9CA3AF'};">${p.media30d > 0 ? p.media30d.toFixed(2) : '-'}</td>
                        <td><a href="https://wa.me/${p.whatsapp.replace(/\D/g, '')}" target="_blank" style="color: #25D366;">${p.whatsapp}</a></td>
                    </tr>
                `).join('');
            }

            const info = document.getElementById('carteirizacaoResultsInfo');
            if (info) info.textContent = `Exibindo ${filtered.length} de ${carteirizacaoData.length} prestadores`;
        }

        function filtrarCarteirizacao(filtro) {
            carteirizacaoFiltroAtual = filtro;

            // Atualizar tabs
            document.querySelectorAll('#carteirizacaoTabs .qualificacao-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.filter === filtro) tab.classList.add('active');
            });

            renderCarteirizacaoTable(filtro);
        }

        async function carregarCarteirizacao() {
            if (carteirizacaoLoaded) {
                renderCarteirizacaoTable(carteirizacaoFiltroAtual);
                return;
            }

            // Mostrar loading
            document.getElementById('carteirizacaoTableBody').innerHTML =
                '<tr><td colspan="8" style="text-align:center;padding:20px;color:#666;">Carregando dados da Query 3622...</td></tr>';

            // Buscar dados da query 3622 se ainda não carregados
            if (CARTEIRIZACAO_DATA.length === 0) {
                try {
                    const rows = await fetchMetabaseData(METABASE_CONFIG.queryAtivosId);
                    if (rows && rows.length > 0) {
                        CARTEIRIZACAO_DATA = rows;
                        console.log(`[Query 3622] Carregados ${rows.length} prestadores ativos`);
                    } else {
                        console.warn('[Query 3622] Nenhum dado retornado. Verifique se está logado no Metabase.');
                        document.getElementById('carteirizacaoTableBody').innerHTML =
                            '<tr><td colspan="8" style="text-align:center;padding:20px;color:#DD2869;">Nenhum dado encontrado. <a href="https://metrics.freelaw.work" target="_blank" style="color:#7C3AED;">Faça login no Metabase</a> e recarregue a página.</td></tr>';
                    }
                } catch (error) {
                    console.error('[Query 3622] Erro ao carregar:', error);
                    document.getElementById('carteirizacaoTableBody').innerHTML =
                        '<tr><td colspan="8" style="text-align:center;padding:20px;color:#DD2869;">Erro ao carregar. <a href="https://metrics.freelaw.work" target="_blank" style="color:#7C3AED;">Faça login no Metabase</a> e recarregue.</td></tr>';
                    return;
                }
            }

            if (CARTEIRIZACAO_DATA.length === 0) return;

            const contadores = processarCarteirizacao(CARTEIRIZACAO_DATA);
            renderCarteirizacaoCards(contadores);
            renderCarteirizacaoChart(contadores);
            renderCarteirizacaoTable('todos');
            document.getElementById('lastUpdateCarteirizacao').textContent = 'Segmentação por Nota Média (30d) • Query 3622 • ' + CARTEIRIZACAO_DATA.length + ' prestadores';
            carteirizacaoLoaded = true;

            // Event listeners
            document.getElementById('carteirizacaoSearch')?.addEventListener('input', () => renderCarteirizacaoTable(carteirizacaoFiltroAtual));
            document.getElementById('carteirizacaoArea')?.addEventListener('change', () => renderCarteirizacaoTable(carteirizacaoFiltroAtual));
        }

        // ==========================================
        // MarIA - Assistente Virtual Inteligente
        // ==========================================
        let mariaOpen = false;
        let currentPrestador = null;
        let mariaMessages = [];

        function toggleMariaChat() {
            mariaOpen = !mariaOpen;
            const modal = document.getElementById('mariaModal');
            const fab = document.getElementById('mariaFab');

            if (mariaOpen) {
                modal.classList.add('active');
                fab.style.display = 'none';
            } else {
                modal.classList.remove('active');
                fab.style.display = 'flex';
            }
        }

        function closeMariaChat() {
            mariaOpen = false;
            document.getElementById('mariaModal').classList.remove('active');
            document.getElementById('mariaFab').style.display = 'flex';
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(' ');
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
            return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
        }

        function findPrestadorByEmail(email) {
            if (!email) return null;
            const emailLower = email.toLowerCase().trim();

            // 1. Buscar na query 3622 (CARTEIRIZACAO_DATA) - prestadores ativos com tier
            const ativoRow = CARTEIRIZACAO_DATA.find(row => row[0] && row[0].toLowerCase() === emailLower);
            if (ativoRow) {
                return {
                    source: '3622',
                    email: ativoRow[0],
                    nome: ativoRow[1],
                    oab: ativoRow[2],
                    whatsapp: ativoRow[3],
                    area: ativoRow[4],
                    experiencia: ativoRow[5] || '',
                    notaProva: ativoRow[6] || '',
                    acertosOnboarding: ativoRow[7] || '',
                    media30d: ativoRow[8],
                    classificacao: ativoRow[9],
                    tier: ativoRow[10] || 'Ativo',
                    status: 'Ativo'
                };
            }

            // 2. Buscar na query 3821 (prestadoresData) - funil completo
            // Estrutura: 0:email, 1:oab, 2:nome, 3:telefone, 4:area, 5:nota, 6:prova_finalizada,
            // 12:is_aprovado, 13:is_ativado, 14:is_desativado, 15:is_desistente, 16:is_bloqueado, 17:is_pendente_admin, 18:is_saida_voluntaria, 19:status_funil
            const funilRow = prestadoresData.find(p => p.email && p.email.toLowerCase() === emailLower);
            if (funilRow) {
                return {
                    source: '3821',
                    email: funilRow.email,
                    nome: funilRow.nome,
                    oab: funilRow.oab,
                    whatsapp: funilRow.telefone,
                    area: funilRow.area,
                    notaProva: funilRow.notaProva || '',
                    tier: funilRow.status || 'Inscrito',
                    status: funilRow.status || 'Inscrito'
                };
            }

            return null;
        }

        function selectPrestador(email) {
            const prestador = findPrestadorByEmail(email);
            if (prestador) {
                currentPrestador = prestador;

                // Atualizar UI - mostrar info do prestador
                const infoSection = document.getElementById('mariaPrestadorInfo');
                infoSection.classList.add('active');
                document.getElementById('mariaPrestadorAvatar').textContent = getInitials(currentPrestador.nome);
                document.getElementById('mariaPrestadorName').textContent = currentPrestador.nome;
                document.getElementById('mariaPrestadorTier').textContent = `${currentPrestador.tier} • ${currentPrestador.area || 'Área não informada'}`;

                // Atualizar placeholder do input
                document.getElementById('mariaChatInput').placeholder = 'Faça uma pergunta sobre ' + currentPrestador.nome.split(' ')[0] + '...';

                // Mensagem de boas-vindas personalizada
                const sourceInfo = currentPrestador.source === '3622' ? '(ativo com métricas)' : '(no funil)';
                addMariaMessage('bot', `Encontrei! <strong>${currentPrestador.nome.split(' ')[0]}</strong> está no <strong>${currentPrestador.tier}</strong> ${sourceInfo}. O que você gostaria de saber?`);
                showSuggestions();
            } else {
                addMariaMessage('bot', `Não encontrei nenhum prestador com o e-mail <strong>${email}</strong>. Verifique se está correto ou tente outro.`);
            }
        }

        function clearPrestador() {
            currentPrestador = null;
            document.getElementById('mariaPrestadorInfo').classList.remove('active');
            document.getElementById('mariaSuggestions').style.display = 'none';
            document.getElementById('mariaChatInput').placeholder = 'Digite um e-mail ou faça uma pergunta...';
            addMariaMessage('bot', 'Prestador removido. Digite outro <strong>e-mail</strong> para consultar.');
        }

        function addMariaMessage(type, content) {
            const messagesContainer = document.getElementById('mariaMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `maria-message ${type}`;

            messageDiv.innerHTML = `
                <div class="maria-message-avatar">${type === 'bot' ? '🤖' : '👤'}</div>
                <div class="maria-message-content">${content}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showSuggestions() {
            document.getElementById('mariaSuggestions').style.display = 'flex';
        }

        function hideSuggestions() {
            document.getElementById('mariaSuggestions').style.display = 'none';
        }

        function askMaria(question) {
            if (!currentPrestador) {
                addMariaMessage('bot', 'Por favor, informe primeiro o e-mail do prestador que você quer consultar.');
                return;
            }

            addMariaMessage('user', question);
            hideSuggestions();

            // Simular delay de digitação
            setTimeout(() => {
                const response = generateMariaResponse(question);
                addMariaMessage('bot', response);
                showSuggestions();
            }, 500);
        }

        function generateMariaResponse(question) {
            const p = currentPrestador;
            const q = question.toLowerCase();

            // Resumo geral
            if (q.includes('resumo') || q.includes('perfil') || q.includes('quem é') || q.includes('sobre')) {
                return `<strong>${p.nome}</strong><br><br>
                    📧 ${p.email}<br>
                    📋 OAB: ${p.oab || 'Não informado'}<br>
                    📱 WhatsApp: ${p.whatsapp || 'Não informado'}<br>
                    ⚖️ Área: ${p.area || 'Não informada'}<br>
                    🏆 Tier: <strong>${p.tier}</strong><br>
                    📊 Status: ${p.classificacao || 'Não classificado'}`;
            }

            // Nota/Performance
            if (q.includes('nota') || q.includes('prova') || q.includes('desempenho')) {
                const nota = p.notaProva !== null ? p.notaProva : 'Não realizou';
                const onboarding = p.acertosOnboarding !== null ? p.acertosOnboarding : 'Não completou';
                return `📝 <strong>Performance na Prova</strong><br><br>
                    Nota na prova técnica: <strong>${nota}</strong><br>
                    Acertos no onboarding: <strong>${onboarding}</strong><br><br>
                    ${p.notaProva >= 9 ? '🌟 Excelente desempenho!' : p.notaProva >= 7 ? '✅ Aprovado com boa nota.' : '⚠️ Pode melhorar.'}`;
            }

            // Média 30 dias
            if (q.includes('média') || q.includes('30 dias') || q.includes('avaliação') || q.includes('últimos')) {
                const media = p.media30d !== null ? p.media30d.toFixed(2) : '0.00';
                return `📈 <strong>Média dos últimos 30 dias</strong><br><br>
                    Avaliação média: <strong>${media}</strong><br><br>
                    ${p.media30d >= 4.5 ? '🌟 Prestador com excelentes avaliações!' :
                      p.media30d >= 3.5 ? '👍 Avaliações positivas.' :
                      p.media30d > 0 ? '⚠️ Atenção: avaliações abaixo do esperado.' :
                      '📭 Ainda não recebeu avaliações recentes.'}`;
            }

            // Tier
            if (q.includes('tier') || q.includes('classificação') || q.includes('nível')) {
                const tierDescriptions = {
                    'Tier S': '🥇 Elite - Top performers com excelente desempenho consistente',
                    'Tier A': '🥈 Excelente - Alta performance e confiabilidade',
                    'Tier B': '🥉 Muito Bom - Bom desempenho geral',
                    'Tier C': '📊 Bom - Performance satisfatória',
                    'Tier D': '📈 Em desenvolvimento - Potencial de crescimento',
                    'Onboarding': '🆕 Novo - Ainda em período de avaliação inicial',
                    'Inativo': '⏸️ Inativo - Sem atividade recente'
                };
                return `🏆 <strong>Classificação Tier</strong><br><br>
                    Tier atual: <strong>${p.tier}</strong><br><br>
                    ${tierDescriptions[p.tier] || 'Classificação não definida.'}`;
            }

            // Área de atuação
            if (q.includes('área') || q.includes('especialidade') || q.includes('atua')) {
                return `⚖️ <strong>Área de Atuação</strong><br><br>
                    Especialidade: <strong>${p.area || 'Não informada'}</strong><br>
                    Experiência: <strong>${p.experiencia || 'Não informada'}</strong>`;
            }

            // Contato
            if (q.includes('contato') || q.includes('telefone') || q.includes('whatsapp') || q.includes('falar')) {
                return `📞 <strong>Informações de Contato</strong><br><br>
                    📧 E-mail: ${p.email}<br>
                    📱 WhatsApp: ${p.whatsapp || 'Não informado'}<br><br>
                    ${p.whatsapp ? `<a href="https://wa.me/${p.whatsapp.replace(/\D/g, '')}" target="_blank" style="color: #22C55E; text-decoration: none;">💬 Abrir WhatsApp</a>` : ''}`;
            }

            // Atividade
            if (q.includes('ativo') || q.includes('trabalh') || q.includes('pegou') || q.includes('serviço')) {
                const pegou = p.classificacao && p.classificacao.includes('Pegou');
                return `📋 <strong>Status de Atividade</strong><br><br>
                    ${pegou ? '✅ <strong>Ativo!</strong> Pegou serviço nos últimos 30 dias.' : '❌ <strong>Inativo.</strong> Não pegou serviço nos últimos 30 dias.'}<br><br>
                    Média de avaliação: <strong>${p.media30d ? p.media30d.toFixed(2) : '0.00'}</strong>`;
            }

            // Resposta genérica
            return `Entendi sua pergunta sobre "${question}". Aqui está o que sei sobre <strong>${p.nome.split(' ')[0]}</strong>:<br><br>
                🏆 Tier: ${p.tier}<br>
                ⚖️ Área: ${p.area || 'Não informada'}<br>
                📊 Média 30d: ${p.media30d ? p.media30d.toFixed(2) : '0.00'}<br><br>
                Posso te ajudar com mais alguma coisa?`;
        }

        function handleMariaChatKeypress(e) {
            if (e.key === 'Enter') {
                sendMariaMessage();
            }
        }

        function isEmail(text) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(text);
        }

        function sendMariaMessage() {
            const input = document.getElementById('mariaChatInput');
            const message = input.value.trim();

            if (!message) return;

            // Detectar se é um e-mail
            if (isEmail(message)) {
                addMariaMessage('user', `Buscar: ${message}`);
                input.value = '';

                // Simular delay
                setTimeout(() => {
                    selectPrestador(message);
                }, 300);
            } else {
                // É uma pergunta
                if (!currentPrestador) {
                    addMariaMessage('user', message);
                    input.value = '';
                    setTimeout(() => {
                        addMariaMessage('bot', 'Para responder suas perguntas, preciso primeiro saber qual prestador você quer consultar. <strong>Digite o e-mail do prestador</strong> (ex: nome@email.com)');
                    }, 300);
                } else {
                    askMaria(message);
                    input.value = '';
                }
            }
        }

        // Inicializar MarIA
        document.addEventListener('DOMContentLoaded', function() {
            // Adicionar mensagem inicial
            setTimeout(() => {
                if (document.getElementById('mariaMessages').children.length === 0) {
                    addMariaMessage('bot', 'Olá! Sou a <strong>MarIA</strong>, sua assistente virtual da Freelaw. 👋<br><br>Digite o <strong>e-mail de um prestador</strong> no campo abaixo para começar. Depois, faça suas perguntas!');
                }
            }, 300);
        });

        // ==========================================
        // QUALIFICAÇÃO - LISTA DE PRESTADORES
        // ==========================================
        // QUALIFICAÇÃO - Usa TODAS as queries para dados precisos
        // ==========================================
        let prestadoresData = [];
        let prestadoresFiltrados = [];
        let contadoresQualificacao = {
            todos: 0,
            inscritos: 0,
            aprovados: 0,
            pendentes: 0,
            ativos: 0,
            bloqueados: 0,
            desativados: 0,
            desistentes: 0,
            saida: 0
        };

        async function carregarPrestadores() {
            try {
                document.getElementById('qualificacaoTableBody').innerHTML =
                    '<tr><td colspan="8" class="qualificacao-loading">Carregando dados...</td></tr>';

                // Buscar query 3821 consolidada + query 3622 para ativos
                const [funilRows, ativosRows] = await Promise.all([
                    fetchMetabaseData(METABASE_CONFIG.queryFunilMasterId),
                    fetchMetabaseData(METABASE_CONFIG.queryAtivosId)
                ]);

                // Verificar se dados foram carregados
                if (!funilRows || funilRows.length === 0) {
                    throw new Error('Nenhum dado retornado');
                }

                // Criar set de emails ativos (query 3622)
                const ativosEmails = new Set((ativosRows || []).map(r => r[0]));

                // Query 3821: 0:email, 1:oab, 2:nome, 3:telefone, 4:area, 5:nota, 6:prova_finalizada,
                // 12:is_aprovado, 13:is_ativado, 14:is_desativado, 15:is_desistente, 16:is_bloqueado, 17:is_pendente_admin, 18:is_saida_voluntaria, 19:status_funil
                prestadoresData = funilRows.map(row => {
                    const email = row[0] || '';
                    const oab = row[1] || '';
                    const nome = row[2] || '';
                    const telefone = row[3] || '';
                    const area = row[4] || '';
                    const nota = row[5];
                    const provaFinalizada = row[6];
                    const statusFunil = row[19] || 'Inscrito';

                    // Mapear status_funil para o formato usado na tabela
                    let status = 'INSCRITO';
                    if (ativosEmails.has(email)) status = 'ATIVO';
                    else if (statusFunil === 'Bloqueado') status = 'BLOQUEADO';
                    else if (statusFunil === 'Desativado') status = 'DESATIVADO';
                    else if (statusFunil === 'Desistente') status = 'DESISTENTE';
                    else if (statusFunil === 'Saída Voluntária') status = 'SAIDA_VOLUNTARIA';
                    else if (statusFunil === 'Pendente Admin') status = 'PENDENTE';
                    else if (statusFunil === 'Aprovado') status = 'APROVADO';
                    else if (statusFunil === 'Ativado') status = 'ATIVO';

                    return {
                        nome,
                        email,
                        telefone,
                        oab,
                        area,
                        status,
                        notaProva: nota,
                        data: provaFinalizada
                    };
                });

                // Atualizar contadores usando a query 3821 consolidada
                contadoresQualificacao = {
                    todos: funilRows.length,
                    inscritos: funilRows.length,
                    aprovados: funilRows.filter(r => r[12] === true).length,
                    pendentes: funilRows.filter(r => r[17] === true).length,
                    ativos: (ativosRows || []).length,
                    bloqueados: funilRows.filter(r => r[16] === true).length,
                    desativados: funilRows.filter(r => r[14] === true).length,
                    desistentes: funilRows.filter(r => r[15] === true).length,
                    saida: funilRows.filter(r => r[18] === true).length
                };

                atualizarContadores();
                aplicarFiltros();

                console.log('Qualificação carregada (query 3821):', contadoresQualificacao);

            } catch (error) {
                console.error('Erro ao carregar prestadores:', error);
                document.getElementById('qualificacaoTableBody').innerHTML =
                    '<tr><td colspan="8" class="qualificacao-loading">Erro ao carregar dados. Verifique se está logado no Metabase.</td></tr>';
            }
        }

        function atualizarContadores() {
            document.getElementById('countTodos').textContent = contadoresQualificacao.todos;
            document.getElementById('countInscritos').textContent = contadoresQualificacao.inscritos;
            document.getElementById('countAprovados').textContent = contadoresQualificacao.aprovados;
            document.getElementById('countPendentes').textContent = contadoresQualificacao.pendentes;
            document.getElementById('countAtivos').textContent = contadoresQualificacao.ativos;
            document.getElementById('countBloqueados').textContent = contadoresQualificacao.bloqueados;
            document.getElementById('countDesativados').textContent = contadoresQualificacao.desativados;
            document.getElementById('countDesistentes').textContent = contadoresQualificacao.desistentes;
            document.getElementById('countSaida').textContent = contadoresQualificacao.saida;
        }

        function aplicarFiltros() {
            const busca = document.getElementById('qualificacaoSearch').value.toLowerCase();
            const area = document.getElementById('qualificacaoArea').value;
            const status = document.getElementById('qualificacaoStatus').value;
            const tabAtiva = document.querySelector('.qualificacao-tab.active')?.dataset.filter || 'todos';

            prestadoresFiltrados = prestadoresData.filter(p => {
                const matchBusca = !busca || p.nome.toLowerCase().includes(busca) ||
                    p.email.toLowerCase().includes(busca) || p.oab.toLowerCase().includes(busca);
                const matchArea = !area || p.area.includes(area);
                const matchStatus = !status || p.status === status;

                // Filtro por tab
                let matchTab = true;
                if (tabAtiva === 'inscritos') matchTab = p.status === 'INSCRITO';
                else if (tabAtiva === 'aprovados') matchTab = p.status === 'APROVADO';
                else if (tabAtiva === 'pendentes') matchTab = p.status === 'PENDENTE';
                else if (tabAtiva === 'ativos') matchTab = p.status === 'ATIVO';
                else if (tabAtiva === 'bloqueados') matchTab = p.status === 'BLOQUEADO';
                else if (tabAtiva === 'desativados') matchTab = p.status === 'DESATIVADO';
                else if (tabAtiva === 'desistentes') matchTab = p.status === 'DESISTENTE';
                else if (tabAtiva === 'saida') matchTab = p.status === 'SAIDA_VOLUNTARIA';

                return matchBusca && matchArea && matchStatus && matchTab;
            });
            renderizarTabela();
        }

        function renderizarTabela() {
            const tbody = document.getElementById('qualificacaoTableBody');
            if (prestadoresFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="qualificacao-loading">Nenhum prestador encontrado.</td></tr>';
                return;
            }
            tbody.innerHTML = prestadoresFiltrados.map(p => {
                const statusClass = p.status.toLowerCase().replace(/_/g, '-');
                const statusLabel = {
                    'INSCRITO': 'Inscrito',
                    'APROVADO': 'Aprovado',
                    'PENDENTE': 'Pendente Admin',
                    'ATIVO': 'Ativo',
                    'BLOQUEADO': 'Bloqueado',
                    'DESATIVADO': 'Desativado',
                    'DESISTENTE': 'Desistente',
                    'SAIDA_VOLUNTARIA': 'Saída Voluntária'
                }[p.status] || p.status;
                const nota = p.notaProva ? parseFloat(p.notaProva).toFixed(1) : '-';
                const data = p.data ? new Date(p.data).toLocaleDateString('pt-BR') : '-';
                return `<tr>
                    <td>${p.nome}</td>
                    <td>${p.email}</td>
                    <td>${p.telefone}</td>
                    <td>${p.oab}</td>
                    <td>${p.area}</td>
                    <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                    <td>${nota}</td>
                    <td>${data}</td>
                </tr>`;
            }).join('');
        }

        function exportarCSV() {
            const headers = ['Nome', 'Email', 'Telefone', 'OAB', 'Área', 'Status', 'Nota Prova', 'Data'];
            const rows = prestadoresFiltrados.map(p => [
                p.nome, p.email, p.telefone, p.oab, p.area, p.status,
                p.notaProva || '', p.data ? new Date(p.data).toLocaleDateString('pt-BR') : ''
            ]);
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `prestadores_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Event Listeners para Qualificação
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('qualificacaoSearch')?.addEventListener('input', aplicarFiltros);
            document.getElementById('qualificacaoArea')?.addEventListener('change', aplicarFiltros);
            document.getElementById('qualificacaoStatus')?.addEventListener('change', aplicarFiltros);
            document.querySelectorAll('.qualificacao-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.qualificacao-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    aplicarFiltros();
                });
            });
        });
    </script>

    <!-- MarIA Floating Action Button -->
    <button class="maria-fab" id="mariaFab" onclick="toggleMariaChat()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <span class="maria-fab-badge">IA</span>
    </button>

    <!-- MarIA Chat Modal -->
    <div class="maria-modal" id="mariaModal">
        <div class="maria-header">
            <div class="maria-avatar">🤖</div>
            <div class="maria-info">
                <div class="maria-name">MarIA</div>
                <div class="maria-status">Assistente IA Freelaw</div>
            </div>
            <button class="maria-close" onclick="closeMariaChat()">✕</button>
        </div>

        <div class="maria-prestador-info" id="mariaPrestadorInfo">
            <div class="maria-prestador-avatar" id="mariaPrestadorAvatar">--</div>
            <div class="maria-prestador-details">
                <div class="maria-prestador-name" id="mariaPrestadorName">--</div>
                <div class="maria-prestador-tier" id="mariaPrestadorTier">--</div>
            </div>
            <button class="maria-prestador-clear" onclick="clearPrestador()">✕</button>
        </div>

        <div class="maria-messages" id="mariaMessages"></div>

        <div class="maria-suggestions" id="mariaSuggestions" style="display: none;">
            <button class="maria-suggestion" onclick="askMaria('Resumo')">📋 Resumo</button>
            <button class="maria-suggestion" onclick="askMaria('Nota na prova')">📝 Nota</button>
            <button class="maria-suggestion" onclick="askMaria('Tier atual')">🏆 Tier</button>
            <button class="maria-suggestion" onclick="askMaria('Média 30 dias')">📈 Média</button>
            <button class="maria-suggestion" onclick="askMaria('Contato')">📞 Contato</button>
            <button class="maria-suggestion" onclick="askMaria('Está ativo?')">✅ Ativo</button>
        </div>

        <div class="maria-input-area">
            <input type="text" id="mariaChatInput" placeholder="E-mail ou pergunta..." onkeypress="handleMariaChatKeypress(event)">
            <button class="maria-send-btn" onclick="sendMariaMessage()">➤</button>
        </div>
    </div>
</body>
</html>
